'use strict';

// handles requests to every route

var db = require('../db/config.js');
var request = require('request');
var app = require('./server.js');
var _ = require('underscore');

var User = db.User;
var Movie = db.Movie;

var omdb = 'http://www.omdbapi.com/?';

module.exports = {
  login: function login(req, res, next) {
    var username = req.body.username;
    var password = req.body.password;
    User.findOne({ username: username, password: password }).then(function (user) {
      if (user) {
        req.session.username = req.body.username;
        req.session.password = req.body.password;
        console.log('Logging in..');
        res.redirect('/');
      } else {
        res.send('Invalid username/password. Please refresh');
      }
    });
  },

  logout: function logout(req, res, next) {
    req.session.username = null;
    req.session.password = null;
    console.log('Logging out..');
    res.redirect('/login');
  },

  signup: function signup(req, res, next) {
    console.log('Signing up..');
    var username = req.body.username;
    var password = req.body.password;
    User.find({ username: username }).then(function (users) {
      if (!users.length) {
        new User({ username: username, password: password }).save().then(function (user) {
          console.log('New user: ', user);
          req.session.username = req.body.username;
          req.session.password = req.body.password;
          res.redirect('/');
        });
      } else {
        console.log('That user already exists');
        res.redirect('/login');
      }
    });
  },

  checkSession: function checkSession(req, res, next) {
    var path = req.path;
    if (path === '/' && path !== '/login' && path !== '/signup') {
      if (!req.session.username || req.session.username === null) {
        res.redirect('/login');
      } else {
        next();
      }
    } else {
      next();
    }
  },

  fetchMovies: function fetchMovies(req, res, next) {
    // fetches movies on login
    var username = req.session.username;
    User.findOne({ username: username }).then(function (user) {
      Movie.find({ '_id': {
          $in: user.movieList
        } }).then(function (movies) {
        res.send(movies);
      });
    });
  },

  addMovie: function addMovie(req, res, next) {
    var movie = req.body.movie.split(' ').join('+');
    var url = omdb + 'tomatoes=true&t=' + movie;
    var username = req.session.username;
    Movie.find({ title: req.body.movie }).then(function (movies) {
      // add movie to db if the query returned empty
      if (!movies.length) {
        request(url, function (err, response, body) {
          if (err) {
            console.log('error from omdb request: ', err);
          } else {
            var data = JSON.parse(response.body);
            console.log('Movie data: ', data);
            var info = {
              title: data.Title,
              year: data.Year,
              img: data.Poster,
              length: data.Runtime,
              plot: data.Plot,
              rating: data.tomatoUserRating
            };
            new Movie(info).save().then(function (movie) {
              console.log('Saving movie to db..');
              console.log('Movie: ', movie);
              User.update({ username: username }, { $push: { movieList: movie._id } }, { safe: true, upsert: true }, function (err, model) {
                if (err) {
                  console.log('err updating user movieList', err);
                }
              });
              res.send(movie);
            });
          }
        });
      } else {
        console.log('Movie: ', movies[0]);
        User.update({ username: username }, { $push: { movieList: movies[0]._id } }, { safe: true, upsert: true }, function (err, model) {
          if (err) {
            console.log('err updating user movieList', err);
          }
        });
        res.send(movies[0]);
      }
    }).catch(function (err) {
      console.log('error in finding movies: ', err);
    });
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvaGFuZGxlcnMuanMiXSwibmFtZXMiOlsiZGIiLCJyZXF1aXJlIiwicmVxdWVzdCIsImFwcCIsIl8iLCJVc2VyIiwiTW92aWUiLCJvbWRiIiwibW9kdWxlIiwiZXhwb3J0cyIsImxvZ2luIiwicmVxIiwicmVzIiwibmV4dCIsInVzZXJuYW1lIiwiYm9keSIsInBhc3N3b3JkIiwiZmluZE9uZSIsInRoZW4iLCJ1c2VyIiwic2Vzc2lvbiIsImNvbnNvbGUiLCJsb2ciLCJyZWRpcmVjdCIsInNlbmQiLCJsb2dvdXQiLCJzaWdudXAiLCJmaW5kIiwidXNlcnMiLCJsZW5ndGgiLCJzYXZlIiwiY2hlY2tTZXNzaW9uIiwicGF0aCIsImZldGNoTW92aWVzIiwiJGluIiwibW92aWVMaXN0IiwibW92aWVzIiwiYWRkTW92aWUiLCJtb3ZpZSIsInNwbGl0Iiwiam9pbiIsInVybCIsInRpdGxlIiwiZXJyIiwicmVzcG9uc2UiLCJkYXRhIiwiSlNPTiIsInBhcnNlIiwiaW5mbyIsIlRpdGxlIiwieWVhciIsIlllYXIiLCJpbWciLCJQb3N0ZXIiLCJSdW50aW1lIiwicGxvdCIsIlBsb3QiLCJyYXRpbmciLCJ0b21hdG9Vc2VyUmF0aW5nIiwidXBkYXRlIiwiJHB1c2giLCJfaWQiLCJzYWZlIiwidXBzZXJ0IiwibW9kZWwiLCJjYXRjaCJdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7QUFFQSxJQUFJQSxLQUFLQyxRQUFRLGlCQUFSLENBQVQ7QUFDQSxJQUFJQyxVQUFVRCxRQUFRLFNBQVIsQ0FBZDtBQUNBLElBQUlFLE1BQU1GLFFBQVEsYUFBUixDQUFWO0FBQ0EsSUFBSUcsSUFBSUgsUUFBUSxZQUFSLENBQVI7O0FBRUEsSUFBSUksT0FBT0wsR0FBR0ssSUFBZDtBQUNBLElBQUlDLFFBQVFOLEdBQUdNLEtBQWY7O0FBRUEsSUFBSUMsT0FBTywwQkFBWDs7QUFFQUMsT0FBT0MsT0FBUCxHQUFpQjtBQUNmQyxTQUFPLGVBQUNDLEdBQUQsRUFBTUMsR0FB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S0E1Q0QsRUE0Q0c2QixLQTVDSCxDQTRDUyxVQUFDdEIsR0FBRCxFQUFTO0FBQ2hCdEIsY0FBUUMsR0FBUixDQUFZLDJCQUFaLEVBQXlDcUIsR0FBekM7QUFDRCxLQTlDRDtBQStDRDtBQXZIYyxDQUFqQiIsImZpbGUiOiJoYW5kbGVycy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIGhhbmRsZXMgcmVxdWVzdHMgdG8gZXZlcnkgcm91dGVcblxudmFyIGRiID0gcmVxdWlyZSgnLi4vZGIvY29uZmlnLmpzJyk7XG52YXIgcmVxdWVzdCA9IHJlcXVpcmUoJ3JlcXVlc3QnKTtcbnZhciBhcHAgPSByZXF1aXJlKCcuL3NlcnZlci5qcycpO1xudmFyIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7XG5cbnZhciBVc2VyID0gZGIuVXNlcjtcbnZhciBNb3ZpZSA9IGRiLk1vdmllO1xuXG52YXIgb21kYiA9ICdodHRwOi8vd3d3Lm9tZGJhcGkuY29tLz8nXG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBsb2dpbjogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgdmFyIHVzZXJuYW1lID0gcmVxLmJvZHkudXNlcm5hbWU7XG4gICAgdmFyIHBhc3N3b3JkID0gcmVxLmJvZHkucGFzc3dvcmQ7XG4gICAgVXNlci5maW5kT25lKHt1c2VybmFtZTogdXNlcm5hbWUsIHBhc3N3b3JkOiBwYXNzd29yZH0pLnRoZW4odXNlciA9PiB7XG4gICAgICBpZiAodXNlcikge1xuICAgICAgICByZXEuc2Vzc2lvbi51c2VybmFtZSA9IHJlcS5ib2R5LnVzZXJuYW1lO1xuICAgICAgICByZXEuc2Vzc2lvbi5wYXNzd29yZCA9IHJlcS5ib2R5LnBhc3N3b3JkO1xuICAgICAgICBjb25zb2xlLmxvZygnTG9nZ2luZyBpbi4uJyk7XG4gICAgICAgIHJlcy5yZWRpcmVjdCgnLycpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzLnNlbmQoJ0ludmFsaWQgdXNlcm5hbWUvcGFzc3dvcmQuIFBsZWFzZSByZWZyZXNoJyk7XG4gICAgICB9XG4gICAgfSlcbiAgfSxcblxuICBsb2dvdXQ6IChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIHJlcS5zZXNzaW9uLnVzZXJuYW1lID0gbnVsbDtcbiAgICByZXEuc2Vzc2lvbi5wYXNzd29yZCA9IG51bGw7XG4gICAgY29uc29sZS5sb2coJ0xvZ2dpbmcgb3V0Li4nKTtcbiAgICByZXMucmVkaXJlY3QoJy9sb2dpbicpO1xuICB9LFxuXG4gIHNpZ251cDogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgY29uc29sZS5sb2coJ1NpZ25pbmcgdXAuLicpO1xuICAgIHZhciB1c2VybmFtZSA9IHJlcS5ib2R5LnVzZXJuYW1lO1xuICAgIHZhciBwYXNzd29yZCA9IHJlcS5ib2R5LnBhc3N3b3JkO1xuICAgIFVzZXIuZmluZCh7dXNlcm5hbWU6IHVzZXJuYW1lfSkudGhlbih1c2VycyA9PiB7XG4gICAgICBpZiAoIXVzZXJzLmxlbmd0aCkge1xuICAgICAgICBuZXcgVXNlcih7dXNlcm5hbWU6IHVzZXJuYW1lLCBwYXNzd29yZDogcGFzc3dvcmR9KS5zYXZlKClcbiAgICAgICAgLnRoZW4odXNlciA9PiB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ05ldyB1c2VyOiAnLCB1c2VyKTtcbiAgICAgICAgICByZXEuc2Vzc2lvbi51c2VybmFtZSA9IHJlcS5ib2R5LnVzZXJuYW1lO1xuICAgICAgICAgIHJlcS5zZXNzaW9uLnBhc3N3b3JkID0gcmVxLmJvZHkucGFzc3dvcmQ7XG4gICAgICAgICAgcmVzLnJlZGlyZWN0KCcvJyk7XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZygnVGhhdCB1c2VyIGFscmVhZHkgZXhpc3RzJyk7XG4gICAgICAgIHJlcy5yZWRpcmVjdCgnL2xvZ2luJyk7XG4gICAgICB9XG4gICAgfSlcbiAgfSxcblxuICBjaGVja1Nlc3Npb246IChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIHZhciBwYXRoID0gcmVxLnBhdGg7XG4gICAgaWYgKHBhdGggPT09ICcvJyAmJiBwYXRoICE9PSAnL2xvZ2luJyAmJiBwYXRoICE9PSAnL3NpZ251cCcpIHtcbiAgICAgIGlmICghcmVxLnNlc3Npb24udXNlcm5hbWUgfHwgcmVxLnNlc3Npb24udXNlcm5hbWUgPT09IG51bGwpIHtcbiAgICAgICAgcmVzLnJlZGlyZWN0KCcvbG9naW4nKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5leHQoKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbmV4dCgpO1xuICAgIH1cbiAgfSxcblxuICBmZXRjaE1vdmllczogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgLy8gZmV0Y2hlcyBtb3ZpZXMgb24gbG9naW5cbiAgICB2YXIgdXNlcm5hbWUgPSByZXEuc2Vzc2lvbi51c2VybmFtZTtcbiAgICBVc2VyLmZpbmRPbmUoe3VzZXJuYW1lOiB1c2VybmFtZX0pLnRoZW4odXNlciA9PiB7XG4gICAgICBNb3ZpZS5maW5kKHsnX2lkJzoge1xuICAgICAgICAkaW46IHVzZXIubW92aWVMaXN0XG4gICAgICB9fSkudGhlbihtb3ZpZXMgPT4ge1xuICAgICAgICByZXMuc2VuZChtb3ZpZXMpO1xuICAgICAgfSlcbiAgICB9KVxuICB9LFxuXG4gIGFkZE1vdmllOiAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICB2YXIgbW92aWUgPSByZXEuYm9keS5tb3ZpZS5zcGxpdCgnICcpLmpvaW4oJysnKTtcbiAgICB2YXIgdXJsID0gb21kYiArICd0b21hdG9lcz10cnVlJnQ9JyArIG1vdmllO1xuICAgIHZhciB1c2VybmFtZSA9IHJlcS5zZXNzaW9uLnVzZXJuYW1lO1xuICAgIE1vdmllLmZpbmQoe3RpdGxlOiByZXEuYm9keS5tb3ZpZX0pLnRoZW4oKG1vdmllcykgPT4ge1xuICAgICAgLy8gYWRkIG1vdmllIHRvIGRiIGlmIHRoZSBxdWVyeSByZXR1cm5lZCBlbXB0eVxuICAgICAgaWYgKCFtb3ZpZXMubGVuZ3RoKSB7XG4gICAgICAgIHJlcXVlc3QodXJsLCBmdW5jdGlvbihlcnIsIHJlc3BvbnNlLCBib2R5KSB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ2Vycm9yIGZyb20gb21kYiByZXF1ZXN0OiAnLCBlcnIpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB2YXIgZGF0YSA9IEpTT04ucGFyc2UocmVzcG9uc2UuYm9keSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnTW92aWUgZGF0YTogJywgZGF0YSk7XG4gICAgICAgICAgICB2YXIgaW5mbyA9IHtcbiAgICAgICAgICAgICAgdGl0bGU6IGRhdGEuVGl0bGUsXG4gICAgICAgICAgICAgIHllYXI6IGRhdGEuWWVhcixcbiAgICAgICAgICAgICAgaW1nOiBkYXRhLlBvc3RlcixcbiAgICAgICAgICAgICAgbGVuZ3RoOiBkYXRhLlJ1bnRpbWUsXG4gICAgICAgICAgICAgIHBsb3Q6IGRhdGEuUGxvdCxcbiAgICAgICAgICAgICAgcmF0aW5nOiBkYXRhLnRvbWF0b1VzZXJSYXRpbmdcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG5ldyBNb3ZpZShpbmZvKS5zYXZlKCkudGhlbihmdW5jdGlvbihtb3ZpZSkge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnU2F2aW5nIG1vdmllIHRvIGRiLi4nKTtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coJ01vdmllOiAnLCBtb3ZpZSk7XG4gICAgICAgICAgICAgIFVzZXIudXBkYXRlKHt1c2VybmFtZTogdXNlcm5hbWV9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICB7JHB1c2g6IHttb3ZpZUxpc3Q6IG1vdmllLl9pZH19LFxuICAgICAgICAgICAgICAgICAgICAgICAgICB7c2FmZTogdHJ1ZSwgdXBzZXJ0OiB0cnVlfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKGVyciwgbW9kZWwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZXJyIHVwZGF0aW5nIHVzZXIgbW92aWVMaXN0JywgZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICByZXMuc2VuZChtb3ZpZSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdNb3ZpZTogJywgbW92aWVzWzBdKTtcbiAgICAgICAgVXNlci51cGRhdGUoe3VzZXJuYW1lOiB1c2VybmFtZX0sXG4gICAgICAgICAgICAgICAgICAgIHskcHVzaDoge21vdmllTGlzdDogbW92aWVzWzBdLl9pZH19LFxuICAgICAgICAgICAgICAgICAgICB7c2FmZTogdHJ1ZSwgdXBzZXJ0OiB0cnVlfSxcbiAgICAgICAgICAgICAgICAgICAgKGVyciwgbW9kZWwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZXJyIHVwZGF0aW5nIHVzZXIgbW92aWVMaXN0JywgZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICByZXMuc2VuZChtb3ZpZXNbMF0pO1xuICAgICAgfVxuICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKCdlcnJvciBpbiBmaW5kaW5nIG1vdmllczogJywgZXJyKTtcbiAgICB9KVxuICB9XG59Il19