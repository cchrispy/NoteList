'use strict';

// handles requests to every route
// interacts with the database

var db = require('../db/config.js');
var request = require('request');
var app = require('./server.js');
var _ = require('underscore');

var User = db.User;
var Movie = db.Movie;

var omdb = 'http://www.omdbapi.com/?';

module.exports = {
  login: function login(req, res, next) {
    var username = req.body.username;
    var password = req.body.password;
    User.findOne({ username: username, password: password }).then(function (user) {
      if (user) {
        req.session.username = req.body.username;
        req.session.password = req.body.password;
        console.log('Logging in..');
        res.redirect('/');
      } else {
        res.send('Invalid username/password. Please refresh');
      }
    });
  },

  logout: function logout(req, res, next) {
    req.session.username = null;
    req.session.password = null;
    console.log('Logging out..');
    res.redirect('/login');
  },

  signup: function signup(req, res, next) {
    console.log('Signing up..');
    var username = req.body.username;
    var password = req.body.password;
    User.find({ username: username }).then(function (users) {
      if (!users.length) {
        new User({ username: username, password: password }).save().then(function (user) {
          console.log('New user: ', user);
          req.session.username = req.body.username;
          req.session.password = req.body.password;
          res.redirect('/');
        });
      } else {
        console.log('That user already exists');
        res.redirect('/login');
      }
    });
  },

  checkSession: function checkSession(req, res, next) {
    var path = req.path;
    if (path === '/' && path !== '/login' && path !== '/signup') {
      if (!req.session.username || req.session.username === null) {
        res.redirect('/login');
      } else {
        next();
      }
    } else {
      next();
    }
  },

  fetchMovies: function fetchMovies(req, res, next) {
    // fetches movies on login
    var username = req.session.username;
    User.findOne({ username: username }).then(function (user) {
      Movie.find({ '_id': {
          $in: user.movieList
        } }).then(function (movies) {
        res.send(movies);
      });
    });
  },

  addMovie: function addMovie(req, res, next) {
    // sends movie info
    var movie = req.body.movie.split(' ').join('+');
    var url = omdb + 'tomatoes=true&t=' + movie;
    var username = req.session.username;
    Movie.find({ title: req.body.movie }).then(function (movies) {
      if (!movies.length) {
        // add movie to db if the query returned empty
        request(url, function (err, response, body) {
          if (err) {
            console.log('error from omdb request: ', err);
          } else {
            var data = JSON.parse(response.body);
            console.log('Movie data: ', data);
            var info = {
              title: data.Title,
              year: data.Year,
              img: data.Poster,
              length: data.Runtime,
              plot: data.Plot,
              rating: data.tomatoUserRating
            };
            new Movie(info).save().then(function (movie) {
              console.log('Saving movie to db..');
              console.log('Movie: ', movie);
              User.update({ username: username }, { $push: { movieList: movie._id } }, { safe: true, upsert: true }, function (err, model) {
                if (err) {
                  console.log('err updating user movieList', err);
                }
              });
              res.send({ matches: [],
                movie: movie });
            });
          }
        });
      } else {
        console.log('Movie: ', movies[0]);
        User.update({ username: username }, { $push: { movieList: movies[0]._id } }, { safe: true, upsert: true }, function (err, model) {
          if (err) {
            console.log('err updating user movieList', err);
          }
        });
        return movies[0];
      }
    }).then(function (movie) {
      // finds users with matching movies
      User.findOne({ username: req.session.username }).then(function (user) {
        User.find({ movieList: { $in: [movie._id] },
          username: { $ne: req.session.username } }).then(function (users) {
          console.log('the matching users: ', users);
          res.send({ matches: users,
            movie: movie });
        });
      });
    }).catch(function (err) {
      console.log('error in finding movies: ', err);
    });
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvaGFuZGxlcnMuanMiXSwibmFtZXMiOlsiZGIiLCJyZXF1aXJlIiwicmVxdWVzdCIsImFwcCIsIl8iLCJVc2VyIiwiTW92aWUiLCJvbWRiIiwibW9kdWxlIiwiZXhwb3J0cyIsImxvZ2luIiwicmVxIiwicmVzIiwibmV4dCIsInVzZXJuYW1lIiwiYm9keSIsInBhc3N3b3JkIiwiZmluZE9uZSIsInRoZW4iLCJ1c2VyIiwic2Vzc2lvbiIsImNvbnNvbGUiLCJsb2ciLCJyZWRpcmVjdCIsInNlbmQiLCJsb2dvdXQiLCJzaWdudXAiLCJmaW5kIiwidXNlcnMiLCJsZW5ndGgiLCJzYXZlIiwiY2hlY2tTZXNzaW9uIiwicGF0aCIsImZldGNoTW92aWVzIiwiJGluIiwibW92aWVMaXN0IiwibW92aWVzIiwiYWRkTW92aWUiLCJtb3ZpZSIsInNwbGl0Iiwiam9pbiIsInVybCIsInRpdGxlIiwiZXJyIiwicmVzcG9uc2UiLCJkYXRhIiwiSlNPTiIsInBhcnNlIiwiaW5mbyIsIlRpdGxlIiwieWVhciIsIlllYXIiLCJpbWciLCJQb3N0ZXIiLCJSdW50aW1lIiwicGxvdCIsIlBsb3QiLCJyYXRpbmciLCJ0b21hdG9Vc2VyUmF0aW5nIiwidXBkYXRlIiwiJHB1c2giLCJfaWQiLCJzYWZlIiwidXBzZXJ0IiwibW9kZWwiLCJtYXRjaGVzIiwiJG5lIiwiY2F0Y2giXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTs7QUFFQSxJQUFJQSxLQUFLQyxRQUFRLGlCQUFSLENBQVQ7QUFDQSxJQUFJQyxVQUFVRCxRQUFRLFNBQVIsQ0FBZDtBQUNBLElBQUlFLE1BQU1GLFFBQVEsYUFBUixDQUFWO0FBQ0EsSUFBSUcsSUFBSUgsUUFBUSxZQUFSLENBQVI7O0FBRUEsSUFBSUksT0FBT0wsR0FBR0ssSUFBZDtBQUNBLElBQUlDLFFBQVFOLEdBQUdNLEtBQWY7O0FBRUEsSUFBSUMsT0FBTywwQkFBWDs7QUFFQUMsT0FBT0MsT0FBUCxHQUFpQjtBQUNmQyxTQUFP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RDtBQUNGLFNBUGI7QUFRQSxlQUFPUCxPQUFPLENBQVAsQ0FBUDtBQUNEO0FBQ0YsS0E3Q0QsRUE2Q0dsQixJQTdDSCxDQTZDUSxVQUFDb0IsS0FBRCxFQUFXO0FBQ2pCO0FBQ0FqQyxXQUFLWSxPQUFMLENBQWEsRUFBQ0gsVUFBVUgsSUFBSVMsT0FBSixDQUFZTixRQUF2QixFQUFiLEVBQStDSSxJQUEvQyxDQUFvRCxnQkFBUTtBQUMxRGIsYUFBS3NCLElBQUwsQ0FBVSxFQUFDUSxXQUFXLEVBQUNELEtBQUssQ0FBQ0ksTUFBTXVCLEdBQVAsQ0FBTixFQUFaO0FBQ0MvQyxvQkFBVSxFQUFDb0QsS0FBS3ZELElBQUlTLE9BQUosQ0FBWU4sUUFBbEIsRUFEWCxFQUFWLEVBQ21ESSxJQURuRCxDQUN3RCxpQkFBUztBQUMvREcsa0JBQVFDLEdBQVIsQ0FBWSxzQkFBWixFQUFvQ00sS0FBcEM7QUFDQWhCLGNBQUlZLElBQUosQ0FBUyxFQUFDeUMsU0FBU3JDLEtBQVY7QUFDQ1UsbUJBQU9BLEtBRFIsRUFBVDtBQUVELFNBTEQ7QUFNRCxPQVBEO0FBUUQsS0F2REQsRUF1REc2QixLQXZESCxDQXVEUyxVQUFDeEIsR0FBRCxFQUFTO0FBQ2hCdEIsY0FBUUMsR0FBUixDQUFZLDJCQUFaLEVBQXlDcUIsR0FBekM7QUFDRCxLQXpERDtBQTBERDtBQW5JYyxDQUFqQiIsImZpbGUiOiJoYW5kbGVycy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIGhhbmRsZXMgcmVxdWVzdHMgdG8gZXZlcnkgcm91dGVcbi8vIGludGVyYWN0cyB3aXRoIHRoZSBkYXRhYmFzZVxuXG52YXIgZGIgPSByZXF1aXJlKCcuLi9kYi9jb25maWcuanMnKTtcbnZhciByZXF1ZXN0ID0gcmVxdWlyZSgncmVxdWVzdCcpO1xudmFyIGFwcCA9IHJlcXVpcmUoJy4vc2VydmVyLmpzJyk7XG52YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKTtcblxudmFyIFVzZXIgPSBkYi5Vc2VyO1xudmFyIE1vdmllID0gZGIuTW92aWU7XG5cbnZhciBvbWRiID0gJ2h0dHA6Ly93d3cub21kYmFwaS5jb20vPydcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGxvZ2luOiAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICB2YXIgdXNlcm5hbWUgPSByZXEuYm9keS51c2VybmFtZTtcbiAgICB2YXIgcGFzc3dvcmQgPSByZXEuYm9keS5wYXNzd29yZDtcbiAgICBVc2VyLmZpbmRPbmUoe3VzZXJuYW1lOiB1c2VybmFtZSwgcGFzc3dvcmQ6IHBhc3N3b3JkfSkudGhlbih1c2VyID0+IHtcbiAgICAgIGlmICh1c2VyKSB7XG4gICAgICAgIHJlcS5zZXNzaW9uLnVzZXJuYW1lID0gcmVxLmJvZHkudXNlcm5hbWU7XG4gICAgICAgIHJlcS5zZXNzaW9uLnBhc3N3b3JkID0gcmVxLmJvZHkucGFzc3dvcmQ7XG4gICAgICAgIGNvbnNvbGUubG9nKCdMb2dnaW5nIGluLi4nKTtcbiAgICAgICAgcmVzLnJlZGlyZWN0KCcvJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuc2VuZCgnSW52YWxpZCB1c2VybmFtZS9wYXNzd29yZC4gUGxlYXNlIHJlZnJlc2gnKTtcbiAgICAgIH1cbiAgICB9KVxuICB9LFxuXG4gIGxvZ291dDogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgcmVxLnNlc3Npb24udXNlcm5hbWUgPSBudWxsO1xuICAgIHJlcS5zZXNzaW9uLnBhc3N3b3JkID0gbnVsbDtcbiAgICBjb25zb2xlLmxvZygnTG9nZ2luZyBvdXQuLicpO1xuICAgIHJlcy5yZWRpcmVjdCgnL2xvZ2luJyk7XG4gIH0sXG5cbiAgc2lnbnVwOiAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICBjb25zb2xlLmxvZygnU2lnbmluZyB1cC4uJyk7XG4gICAgdmFyIHVzZXJuYW1lID0gcmVxLmJvZHkudXNlcm5hbWU7XG4gICAgdmFyIHBhc3N3b3JkID0gcmVxLmJvZHkucGFzc3dvcmQ7XG4gICAgVXNlci5maW5kKHt1c2VybmFtZTogdXNlcm5hbWV9KS50aGVuKHVzZXJzID0+IHtcbiAgICAgIGlmICghdXNlcnMubGVuZ3RoKSB7XG4gICAgICAgIG5ldyBVc2VyKHt1c2VybmFtZTogdXNlcm5hbWUsIHBhc3N3b3JkOiBwYXNzd29yZH0pLnNhdmUoKVxuICAgICAgICAudGhlbih1c2VyID0+IHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnTmV3IHVzZXI6ICcsIHVzZXIpO1xuICAgICAgICAgIHJlcS5zZXNzaW9uLnVzZXJuYW1lID0gcmVxLmJvZHkudXNlcm5hbWU7XG4gICAgICAgICAgcmVxLnNlc3Npb24ucGFzc3dvcmQgPSByZXEuYm9keS5wYXNzd29yZDtcbiAgICAgICAgICByZXMucmVkaXJlY3QoJy8nKTtcbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdUaGF0IHVzZXIgYWxyZWFkeSBleGlzdHMnKTtcbiAgICAgICAgcmVzLnJlZGlyZWN0KCcvbG9naW4nKTtcbiAgICAgIH1cbiAgICB9KVxuICB9LFxuXG4gIGNoZWNrU2Vzc2lvbjogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgdmFyIHBhdGggPSByZXEucGF0aDtcbiAgICBpZiAocGF0aCA9PT0gJy8nICYmIHBhdGggIT09ICcvbG9naW4nICYmIHBhdGggIT09ICcvc2lnbnVwJykge1xuICAgICAgaWYgKCFyZXEuc2Vzc2lvbi51c2VybmFtZSB8fCByZXEuc2Vzc2lvbi51c2VybmFtZSA9PT0gbnVsbCkge1xuICAgICAgICByZXMucmVkaXJlY3QoJy9sb2dpbicpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbmV4dCgpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBuZXh0KCk7XG4gICAgfVxuICB9LFxuXG4gIGZldGNoTW92aWVzOiAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAvLyBmZXRjaGVzIG1vdmllcyBvbiBsb2dpblxuICAgIHZhciB1c2VybmFtZSA9IHJlcS5zZXNzaW9uLnVzZXJuYW1lO1xuICAgIFVzZXIuZmluZE9uZSh7dXNlcm5hbWU6IHVzZXJuYW1lfSkudGhlbih1c2VyID0+IHtcbiAgICAgIE1vdmllLmZpbmQoeydfaWQnOiB7XG4gICAgICAgICRpbjogdXNlci5tb3ZpZUxpc3RcbiAgICAgIH19KS50aGVuKG1vdmllcyA9PiB7XG4gICAgICAgIHJlcy5zZW5kKG1vdmllcyk7XG4gICAgICB9KVxuICAgIH0pXG4gIH0sXG5cbiAgYWRkTW92aWU6IChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIC8vIHNlbmRzIG1vdmllIGluZm9cbiAgICB2YXIgbW92aWUgPSByZXEuYm9keS5tb3ZpZS5zcGxpdCgnICcpLmpvaW4oJysnKTtcbiAgICB2YXIgdXJsID0gb21kYiArICd0b21hdG9lcz10cnVlJnQ9JyArIG1vdmllO1xuICAgIHZhciB1c2VybmFtZSA9IHJlcS5zZXNzaW9uLnVzZXJuYW1lO1xuICAgIE1vdmllLmZpbmQoe3RpdGxlOiByZXEuYm9keS5tb3ZpZX0pLnRoZW4oKG1vdmllcykgPT4ge1xuICAgICAgaWYgKCFtb3ZpZXMubGVuZ3RoKSB7XG4gICAgICAgIC8vIGFkZCBtb3ZpZSB0byBkYiBpZiB0aGUgcXVlcnkgcmV0dXJuZWQgZW1wdHlcbiAgICAgICAgcmVxdWVzdCh1cmwsIGZ1bmN0aW9uKGVyciwgcmVzcG9uc2UsIGJvZHkpIHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnZXJyb3IgZnJvbSBvbWRiIHJlcXVlc3Q6ICcsIGVycik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciBkYXRhID0gSlNPTi5wYXJzZShyZXNwb25zZS5ib2R5KTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdNb3ZpZSBkYXRhOiAnLCBkYXRhKTtcbiAgICAgICAgICAgIHZhciBpbmZvID0ge1xuICAgICAgICAgICAgICB0aXRsZTogZGF0YS5UaXRsZSxcbiAgICAgICAgICAgICAgeWVhcjogZGF0YS5ZZWFyLFxuICAgICAgICAgICAgICBpbWc6IGRhdGEuUG9zdGVyLFxuICAgICAgICAgICAgICBsZW5ndGg6IGRhdGEuUnVudGltZSxcbiAgICAgICAgICAgICAgcGxvdDogZGF0YS5QbG90LFxuICAgICAgICAgICAgICByYXRpbmc6IGRhdGEudG9tYXRvVXNlclJhdGluZ1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbmV3IE1vdmllKGluZm8pLnNhdmUoKS50aGVuKGZ1bmN0aW9uKG1vdmllKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdTYXZpbmcgbW92aWUgdG8gZGIuLicpO1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnTW92aWU6ICcsIG1vdmllKTtcbiAgICAgICAgICAgICAgVXNlci51cGRhdGUoe3VzZXJuYW1lOiB1c2VybmFtZX0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHskcHVzaDoge21vdmllTGlzdDogbW92aWUuX2lkfX0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHtzYWZlOiB0cnVlLCB1cHNlcnQ6IHRydWV9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAoZXJyLCBtb2RlbCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlcnIgdXBkYXRpbmcgdXNlciBtb3ZpZUxpc3QnLCBlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIHJlcy5zZW5kKHttYXRjaGVzOiBbXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vdmllOiBtb3ZpZX0pO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZygnTW92aWU6ICcsIG1vdmllc1swXSk7XG4gICAgICAgIFVzZXIudXBkYXRlKHt1c2VybmFtZTogdXNlcm5hbWV9LFxuICAgICAgICAgICAgICAgICAgICB7JHB1c2g6IHttb3ZpZUxpc3Q6IG1vdmllc1swXS5faWR9fSxcbiAgICAgICAgICAgICAgICAgICAge3NhZmU6IHRydWUsIHVwc2VydDogdHJ1ZX0sXG4gICAgICAgICAgICAgICAgICAgIChlcnIsIG1vZGVsKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2VyciB1cGRhdGluZyB1c2VyIG1vdmllTGlzdCcsIGVycik7XG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG1vdmllc1swXVxuICAgICAgfVxuICAgIH0pLnRoZW4oKG1vdmllKSA9PiB7XG4gICAgICAvLyBmaW5kcyB1c2VycyB3aXRoIG1hdGNoaW5nIG1vdmllc1xuICAgICAgVXNlci5maW5kT25lKHt1c2VybmFtZTogcmVxLnNlc3Npb24udXNlcm5hbWV9KS50aGVuKHVzZXIgPT4ge1xuICAgICAgICBVc2VyLmZpbmQoe21vdmllTGlzdDogeyRpbjogW21vdmllLl9pZF19LFxuICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiB7JG5lOiByZXEuc2Vzc2lvbi51c2VybmFtZX19KS50aGVuKHVzZXJzID0+IHtcbiAgICAgICAgICBjb25zb2xlLmxvZygndGhlIG1hdGNoaW5nIHVzZXJzOiAnLCB1c2Vycyk7XG4gICAgICAgICAgcmVzLnNlbmQoe21hdGNoZXM6IHVzZXJzLFxuICAgICAgICAgICAgICAgICAgICBtb3ZpZTogbW92aWV9KTtcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ2Vycm9yIGluIGZpbmRpbmcgbW92aWVzOiAnLCBlcnIpO1xuICAgIH0pXG4gIH0sXG59Il19