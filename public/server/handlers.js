'use strict';

// handles requests to every route

var db = require('../db/config.js');
var request = require('request');
var app = require('./server.js');
var _ = require('underscore');

var User = db.User;
var Movie = db.Movie;

var omdb = 'http://www.omdbapi.com/?';

module.exports = {
  login: function login(req, res, next) {
    var username = req.body.username;
    var password = req.body.password;
    User.findOne({ username: username, password: password }).then(function (user) {
      if (user) {
        req.session.username = req.body.username;
        req.session.password = req.body.password;
        console.log('Loggin in..');
        res.redirect('/');
      } else {
        res.send('Invalid username/password. Please refresh');
      }
    });
  },

  logout: function logout(req, res, next) {
    req.session.username = null;
    req.session.password = null;
    console.log('Logging out..');
    res.redirect('/login');
  },

  signup: function signup(req, res, next) {
    console.log('Signing up..');
    var username = req.body.username;
    var password = req.body.password;
    User.find({ username: username }).then(function (users) {
      if (!users.length) {
        new User({ username: username, password: password }).save().then(function (user) {
          console.log('New user: ', user);
          req.session.username = req.body.username;
          req.session.password = req.body.password;
          res.redirect('/');
        });
      } else {
        console.log('That user already exists');
        res.redirect('/login');
      }
    });
  },

  checkSession: function checkSession(req, res, next) {
    var path = req.path;
    if (path === '/' && path !== '/login' && path !== '/signup') {
      if (!req.session.username || req.session.username === null) {
        res.redirect('/login');
      } else {
        next();
      }
    } else {
      next();
    }
  },

  addMovie: function addMovie(req, res, next) {
    var movie = req.body.movie.split(' ').join('+');
    var url = omdb + 'tomatoes=true&t=' + movie;
    Movie.find({ title: req.body.movie }).then(function (movies) {
      // add movie to db if the query returned empty
      if (!movies.length) {
        request(url, function (err, response, body) {
          if (err) {
            console.log('error from omdb request: ', err);
          } else {
            var data = JSON.parse(response.body);
            console.log(data);
            var info = {
              title: data.Title,
              year: data.Year,
              img: data.Poster,
              length: data.Runtime,
              plot: data.Plot,
              rating: data.tomatoUserRating
            };
            new Movie(info).save().then(function (movie) {
              console.log('Saving movie to db');
              res.send(movie);
            });
          }
        });
      } else {
        res.send(movies[0]);
      }
    }).catch(function (err) {
      console.log('error in finding movies: ', err);
    });
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvaGFuZGxlcnMuanMiXSwibmFtZXMiOlsiZGIiLCJyZXF1aXJlIiwicmVxdWVzdCIsImFwcCIsIl8iLCJVc2VyIiwiTW92aWUiLCJvbWRiIiwibW9kdWxlIiwiZXhwb3J0cyIsImxvZ2luIiwicmVxIiwicmVzIiwibmV4dCIsInVzZXJuYW1lIiwiYm9keSIsInBhc3N3b3JkIiwiZmluZE9uZSIsInRoZW4iLCJ1c2VyIiwic2Vzc2lvbiIsImNvbnNvbGUiLCJsb2ciLCJyZWRpcmVjdCIsInNlbmQiLCJsb2dvdXQiLCJzaWdudXAiLCJmaW5kIiwidXNlcnMiLCJsZW5ndGgiLCJzYXZlIiwiY2hlY2tTZXNzaW9uIiwicGF0aCIsImFkZE1vdmllIiwibW92aWUiLCJzcGxpdCIsImpvaW4iLCJ1cmwiLCJ0aXRsZSIsIm1vdmllcyIsImVyciIsInJlc3BvbnNlIiwiZGF0YSIsIkpTT04iLCJwYXJzZSIsImluZm8iLCJUaXRsZSIsInllYXIiLCJZZWFyIiwiaW1nIiwiUG9zdGVyIiwiUnVudGltZSIsInBsb3QiLCJQbG90IiwicmF0aW5nIiwidG9tYXRvVXNlclJhdGluZyIsImNhdGNoIl0sIm1hcHBpbmdzIjoiOztBQUFBOztBQUVBLElBQUlBLEtBQUtDLFFBQVEsaUJBQVIsQ0FBVDtBQUNBLElBQUlDLFVBQVVELFFBQVEsU0FBUixDQUFkO0FBQ0EsSUFBSUUsTUFBTUYsUUFBUSxhQUFSLENBQVY7QUFDQSxJQUFJRyxJQUFJSCxRQUFRLFlBQVIsQ0FBUjs7QUFFQSxJQUFJSSxPQUFPTCxHQUFHSyxJQUFkO0FBQ0EsSUFBSUMsUUFBUU4sR0FBR00sS0FBZjs7QUFFQSxJQUFJQyxPQUFPLDBCQUFYOztBQUVBQyxPQUFPQyxPQUFQLEdBQWlCO0FBQ2ZDLFNBQU8sZUFBQ0MsR0FBRCxFQUFNQyxHQUFOLEVBQVdDLElBQVgsRUFBb0I7QUFDekIsUUFBSUMsV0FBV0gsSUFBSUksSUFBSixDQUFTRCxRQUF4QjtBQUNBLFFBQUlFLFdBQVdMLElB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ZXZlcnkgcm91dGVcblxudmFyIGRiID0gcmVxdWlyZSgnLi4vZGIvY29uZmlnLmpzJyk7XG52YXIgcmVxdWVzdCA9IHJlcXVpcmUoJ3JlcXVlc3QnKTtcbnZhciBhcHAgPSByZXF1aXJlKCcuL3NlcnZlci5qcycpO1xudmFyIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7XG5cbnZhciBVc2VyID0gZGIuVXNlcjtcbnZhciBNb3ZpZSA9IGRiLk1vdmllO1xuXG52YXIgb21kYiA9ICdodHRwOi8vd3d3Lm9tZGJhcGkuY29tLz8nXG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBsb2dpbjogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgdmFyIHVzZXJuYW1lID0gcmVxLmJvZHkudXNlcm5hbWU7XG4gICAgdmFyIHBhc3N3b3JkID0gcmVxLmJvZHkucGFzc3dvcmQ7XG4gICAgVXNlci5maW5kT25lKHt1c2VybmFtZTogdXNlcm5hbWUsIHBhc3N3b3JkOiBwYXNzd29yZH0pLnRoZW4odXNlciA9PiB7XG4gICAgICBpZiAodXNlcikge1xuICAgICAgICByZXEuc2Vzc2lvbi51c2VybmFtZSA9IHJlcS5ib2R5LnVzZXJuYW1lO1xuICAgICAgICByZXEuc2Vzc2lvbi5wYXNzd29yZCA9IHJlcS5ib2R5LnBhc3N3b3JkO1xuICAgICAgICBjb25zb2xlLmxvZygnTG9nZ2luIGluLi4nKTtcbiAgICAgICAgcmVzLnJlZGlyZWN0KCcvJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuc2VuZCgnSW52YWxpZCB1c2VybmFtZS9wYXNzd29yZC4gUGxlYXNlIHJlZnJlc2gnKTtcbiAgICAgIH1cbiAgICB9KVxuICB9LFxuXG4gIGxvZ291dDogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgcmVxLnNlc3Npb24udXNlcm5hbWUgPSBudWxsO1xuICAgIHJlcS5zZXNzaW9uLnBhc3N3b3JkID0gbnVsbDtcbiAgICBjb25zb2xlLmxvZygnTG9nZ2luZyBvdXQuLicpO1xuICAgIHJlcy5yZWRpcmVjdCgnL2xvZ2luJyk7XG4gIH0sXG5cbiAgc2lnbnVwOiAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICBjb25zb2xlLmxvZygnU2lnbmluZyB1cC4uJyk7XG4gICAgdmFyIHVzZXJuYW1lID0gcmVxLmJvZHkudXNlcm5hbWU7XG4gICAgdmFyIHBhc3N3b3JkID0gcmVxLmJvZHkucGFzc3dvcmQ7XG4gICAgVXNlci5maW5kKHt1c2VybmFtZTogdXNlcm5hbWV9KS50aGVuKHVzZXJzID0+IHtcbiAgICAgIGlmICghdXNlcnMubGVuZ3RoKSB7XG4gICAgICAgIG5ldyBVc2VyKHt1c2VybmFtZTogdXNlcm5hbWUsIHBhc3N3b3JkOiBwYXNzd29yZH0pLnNhdmUoKVxuICAgICAgICAudGhlbih1c2VyID0+IHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnTmV3IHVzZXI6ICcsIHVzZXIpO1xuICAgICAgICAgIHJlcS5zZXNzaW9uLnVzZXJuYW1lID0gcmVxLmJvZHkudXNlcm5hbWU7XG4gICAgICAgICAgcmVxLnNlc3Npb24ucGFzc3dvcmQgPSByZXEuYm9keS5wYXNzd29yZDtcbiAgICAgICAgICByZXMucmVkaXJlY3QoJy8nKTtcbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdUaGF0IHVzZXIgYWxyZWFkeSBleGlzdHMnKTtcbiAgICAgICAgcmVzLnJlZGlyZWN0KCcvbG9naW4nKTtcbiAgICAgIH1cbiAgICB9KVxuICB9LFxuXG4gIGNoZWNrU2Vzc2lvbjogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgdmFyIHBhdGggPSByZXEucGF0aDtcbiAgICBpZiAocGF0aCA9PT0gJy8nICYmIHBhdGggIT09ICcvbG9naW4nICYmIHBhdGggIT09ICcvc2lnbnVwJykge1xuICAgICAgaWYgKCFyZXEuc2Vzc2lvbi51c2VybmFtZSB8fCByZXEuc2Vzc2lvbi51c2VybmFtZSA9PT0gbnVsbCkge1xuICAgICAgICByZXMucmVkaXJlY3QoJy9sb2dpbicpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbmV4dCgpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBuZXh0KCk7XG4gICAgfVxuICB9LFxuXG4gIGFkZE1vdmllOiAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICB2YXIgbW92aWUgPSByZXEuYm9keS5tb3ZpZS5zcGxpdCgnICcpLmpvaW4oJysnKTtcbiAgICB2YXIgdXJsID0gb21kYiArICd0b21hdG9lcz10cnVlJnQ9JyArIG1vdmllO1xuICAgIE1vdmllLmZpbmQoe3RpdGxlOiByZXEuYm9keS5tb3ZpZX0pLnRoZW4oKG1vdmllcykgPT4ge1xuICAgICAgLy8gYWRkIG1vdmllIHRvIGRiIGlmIHRoZSBxdWVyeSByZXR1cm5lZCBlbXB0eVxuICAgICAgaWYgKCFtb3ZpZXMubGVuZ3RoKSB7XG4gICAgICAgIHJlcXVlc3QodXJsLCBmdW5jdGlvbihlcnIsIHJlc3BvbnNlLCBib2R5KSB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ2Vycm9yIGZyb20gb21kYiByZXF1ZXN0OiAnLCBlcnIpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB2YXIgZGF0YSA9IEpTT04ucGFyc2UocmVzcG9uc2UuYm9keSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhkYXRhKTtcbiAgICAgICAgICAgIHZhciBpbmZvID0ge1xuICAgICAgICAgICAgICB0aXRsZTogZGF0YS5UaXRsZSxcbiAgICAgICAgICAgICAgeWVhcjogZGF0YS5ZZWFyLFxuICAgICAgICAgICAgICBpbWc6IGRhdGEuUG9zdGVyLFxuICAgICAgICAgICAgICBsZW5ndGg6IGRhdGEuUnVudGltZSxcbiAgICAgICAgICAgICAgcGxvdDogZGF0YS5QbG90LFxuICAgICAgICAgICAgICByYXRpbmc6IGRhdGEudG9tYXRvVXNlclJhdGluZ1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbmV3IE1vdmllKGluZm8pLnNhdmUoKS50aGVuKGZ1bmN0aW9uKG1vdmllKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdTYXZpbmcgbW92aWUgdG8gZGInKTtcbiAgICAgICAgICAgICAgcmVzLnNlbmQobW92aWUpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuc2VuZChtb3ZpZXNbMF0pO1xuICAgICAgfVxuICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKCdlcnJvciBpbiBmaW5kaW5nIG1vdmllczogJywgZXJyKTtcbiAgICB9KVxuICB9XG59Il19