'use strict';

// handles requests to every route
// interacts with the database

var db = require('../db/config.js');
var request = require('request');
var app = require('./server.js');
var _ = require('underscore');

var User = db.User;
var Movie = db.Movie;

var omdb = 'http://www.omdbapi.com/?';

module.exports = {
  login: function login(req, res, next) {
    var username = req.body.username;
    var password = req.body.password;
    User.findOne({ username: username, password: password }).then(function (user) {
      if (user) {
        req.session.username = req.body.username;
        req.session.password = req.body.password;
        req.session.picture = user.picture;
        console.log('Logging in..');
        res.redirect('/');
      } else {
        res.send('Invalid username/password. Please refresh');
      }
    });
  },

  logout: function logout(req, res, next) {
    req.session.username = null;
    req.session.password = null;
    req.session.picture = null;
    console.log('Logging out..');
    res.redirect('/login');
  },

  signup: function signup(req, res, next) {
    console.log('Signing up..');
    var username = req.body.username;
    var password = req.body.password;
    var picture = req.body.picture || '';
    User.find({ username: username }).then(function (users) {
      if (!users.length) {
        new User({ username: username, password: password, picture: picture }).save().then(function (user) {
          console.log('New user: ', user);
          req.session.username = username;
          req.session.password = password;
          req.session.picture = picture;
          res.redirect('/');
        });
      } else {
        console.log('That user already exists');
        res.redirect('/login');
      }
    });
  },

  checkSession: function checkSession(req, res, next) {
    var path = req.path;
    if (path === '/' && path !== '/login' && path !== '/signup') {
      if (!req.session.username || req.session.username === null) {
        res.redirect('/login');
      } else {
        next();
      }
    } else {
      next();
    }
  },

  fetchMovies: function fetchMovies(req, res, next) {
    // fetches movies on login, and profile picture
    var username = req.session.username;
    var picture = req.session.picture;
    console.log(username, picture);
    User.findOne({ username: username }).then(function (user) {
      Movie.find({ '_id': {
          $in: user.movieList
        } }).then(function (movies) {
        res.send({ movies: movies, picture: picture });
      });
    });
  },

  matchUser: function matchUser(req, res, next) {
    var match = req.body.match;
    User.findOne({ username: match }).then(function (user) {
      console.log('Matched user found: ', user);
      res.send(user);
    });
  },

  addMovie: function addMovie(req, res, next) {
    // sends movie info
    var movie = req.body.movie.split(' ').join('+');
    var url = omdb + 'tomatoes=true&t=' + movie;
    var username = req.session.username;
    Movie.find({ title: req.body.movie }).then(function (movies) {
      if (!movies.length) {
        // add movie to db if the query returned empty
        request(url, function (err, response, body) {
          if (err) {
            console.log('error from omdb request: ', err);
          } else {
            var data = JSON.parse(response.body);
            console.log('Movie data: ', data);
            var info = {
              title: data.Title,
              year: data.Year,
              img: data.Poster,
              length: data.Runtime,
              plot: data.Plot,
              rating: data.tomatoUserRating
            };
            new Movie(info).save().then(function (movie) {
              console.log('Saving movie to db..');
              console.log('Movie: ', movie);
              User.update({ username: username }, { $push: { movieList: movie._id } }, { safe: true, upsert: true }, function (err, model) {
                if (err) {
                  console.log('err updating user movieList', err);
                }
              });
              res.send({ matches: [],
                movie: movie });
            });
          }
        });
      } else {
        console.log('Movie: ', movies[0]);
        User.update({ username: username }, { $push: { movieList: movies[0]._id } }, { safe: true, upsert: true }, function (err, model) {
          if (err) {
            console.log('err updating user movieList', err);
          }
        });
        return movies[0];
      }
    }).then(function (movie) {
      // finds users with matching movies
      User.findOne({ username: req.session.username }).then(function (user) {
        User.find({ movieList: { $in: [movie._id] },
          username: { $ne: req.session.username } }).then(function (users) {
          console.log('the matching users: ', users);
          res.send({ matches: users,
            movie: movie });
        });
      });
    }).catch(function (err) {
      console.log('error in finding movies: ', err);
    });
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvaGFuZGxlcnMuanMiXSwibmFtZXMiOlsiZGIiLCJyZXF1aXJlIiwicmVxdWVzdCIsImFwcCIsIl8iLCJVc2VyIiwiTW92aWUiLCJvbWRiIiwibW9kdWxlIiwiZXhwb3J0cyIsImxvZ2luIiwicmVxIiwicmVzIiwibmV4dCIsInVzZXJuYW1lIiwiYm9keSIsInBhc3N3b3JkIiwiZmluZE9uZSIsInRoZW4iLCJ1c2VyIiwic2Vzc2lvbiIsInBpY3R1cmUiLCJjb25zb2xlIiwibG9nIiwicmVkaXJlY3QiLCJzZW5kIiwibG9nb3V0Iiwic2lnbnVwIiwiZmluZCIsInVzZXJzIiwibGVuZ3RoIiwic2F2ZSIsImNoZWNrU2Vzc2lvbiIsInBhdGgiLCJmZXRjaE1vdmllcyIsIiRpbiIsIm1vdmllTGlzdCIsIm1vdmllcyIsIm1hdGNoVXNlciIsIm1hdGNoIiwiYWRkTW92aWUiLCJtb3ZpZSIsInNwbGl0Iiwiam9pbiIsInVybCIsInRpdGxlIiwiZXJyIiwicmVzcG9uc2UiLCJkYXRhIiwiSlNPTiIsInBhcnNlIiwiaW5mbyIsIlRpdGxlIiwieWVhciIsIlllYXIiLCJpbWciLCJQb3N0ZXIiLCJSdW50aW1lIiwicGxvdCIsIlBsb3QiLCJyYXRpbmciLCJ0b21hdG9Vc2VyUmF0aW5nIiwidXBkYXRlIiwiJHB1c2giLCJfaWQiLCJzYWZlIiwidXBzZXJ0IiwibW9kZWwiLCJtYXRjaGVzIiwiJG5lIiwiY2F0Y2giXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTs7QUFFQSxJQUFJQSxLQUFLQyxRQUFRLGlCQUFSLENBQVQ7QUFDQSxJQUFJQyxVQUFVRCxRQUFRLFNBQVIsQ0FBZDtBQUNBLElBQUlFLE1BQU1GLFFBQVEsYUFBUixDQUFWO0FBQ0EsSUFBSUcsSUFBSUgsUUFBUSxZQUFSLENBQVI7O0FBRUEsSUFBSUksT0FBT0wsR0FBR0ssSUFBZDtBQUNBLElBQUlDLFFBQVFOLEdBQUdNLEtBQWY7O0FBRUEsSUFBSUMsT0FBTywwQkFBWDs7QUFF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Q21ESSxJQURuRCxDQUN3RCxpQkFBUztBQUMvREksa0JBQVFDLEdBQVIsQ0FBWSxzQkFBWixFQUFvQ00sS0FBcEM7QUFDQWpCLGNBQUlhLElBQUosQ0FBUyxFQUFDMkMsU0FBU3ZDLEtBQVY7QUFDQ1ksbUJBQU9BLEtBRFIsRUFBVDtBQUVELFNBTEQ7QUFNRCxPQVBEO0FBUUQsS0F2REQsRUF1REc2QixLQXZESCxDQXVEUyxVQUFDeEIsR0FBRCxFQUFTO0FBQ2hCeEIsY0FBUUMsR0FBUixDQUFZLDJCQUFaLEVBQXlDdUIsR0FBekM7QUFDRCxLQXpERDtBQTBERDtBQWpKYyxDQUFqQiIsImZpbGUiOiJoYW5kbGVycy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIGhhbmRsZXMgcmVxdWVzdHMgdG8gZXZlcnkgcm91dGVcbi8vIGludGVyYWN0cyB3aXRoIHRoZSBkYXRhYmFzZVxuXG52YXIgZGIgPSByZXF1aXJlKCcuLi9kYi9jb25maWcuanMnKTtcbnZhciByZXF1ZXN0ID0gcmVxdWlyZSgncmVxdWVzdCcpO1xudmFyIGFwcCA9IHJlcXVpcmUoJy4vc2VydmVyLmpzJyk7XG52YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKTtcblxudmFyIFVzZXIgPSBkYi5Vc2VyO1xudmFyIE1vdmllID0gZGIuTW92aWU7XG5cbnZhciBvbWRiID0gJ2h0dHA6Ly93d3cub21kYmFwaS5jb20vPydcblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGxvZ2luOiAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICB2YXIgdXNlcm5hbWUgPSByZXEuYm9keS51c2VybmFtZTtcbiAgICB2YXIgcGFzc3dvcmQgPSByZXEuYm9keS5wYXNzd29yZDtcbiAgICBVc2VyLmZpbmRPbmUoe3VzZXJuYW1lOiB1c2VybmFtZSwgcGFzc3dvcmQ6IHBhc3N3b3JkfSkudGhlbih1c2VyID0+IHtcbiAgICAgIGlmICh1c2VyKSB7XG4gICAgICAgIHJlcS5zZXNzaW9uLnVzZXJuYW1lID0gcmVxLmJvZHkudXNlcm5hbWU7XG4gICAgICAgIHJlcS5zZXNzaW9uLnBhc3N3b3JkID0gcmVxLmJvZHkucGFzc3dvcmQ7XG4gICAgICAgIHJlcS5zZXNzaW9uLnBpY3R1cmUgPSB1c2VyLnBpY3R1cmU7XG4gICAgICAgIGNvbnNvbGUubG9nKCdMb2dnaW5nIGluLi4nKTtcbiAgICAgICAgcmVzLnJlZGlyZWN0KCcvJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuc2VuZCgnSW52YWxpZCB1c2VybmFtZS9wYXNzd29yZC4gUGxlYXNlIHJlZnJlc2gnKTtcbiAgICAgIH1cbiAgICB9KVxuICB9LFxuXG4gIGxvZ291dDogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgcmVxLnNlc3Npb24udXNlcm5hbWUgPSBudWxsO1xuICAgIHJlcS5zZXNzaW9uLnBhc3N3b3JkID0gbnVsbDtcbiAgICByZXEuc2Vzc2lvbi5waWN0dXJlID0gbnVsbDtcbiAgICBjb25zb2xlLmxvZygnTG9nZ2luZyBvdXQuLicpO1xuICAgIHJlcy5yZWRpcmVjdCgnL2xvZ2luJyk7XG4gIH0sXG5cbiAgc2lnbnVwOiAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICBjb25zb2xlLmxvZygnU2lnbmluZyB1cC4uJyk7XG4gICAgdmFyIHVzZXJuYW1lID0gcmVxLmJvZHkudXNlcm5hbWU7XG4gICAgdmFyIHBhc3N3b3JkID0gcmVxLmJvZHkucGFzc3dvcmQ7XG4gICAgdmFyIHBpY3R1cmUgPSByZXEuYm9keS5waWN0dXJlIHx8ICcnO1xuICAgIFVzZXIuZmluZCh7dXNlcm5hbWU6IHVzZXJuYW1lfSkudGhlbih1c2VycyA9PiB7XG4gICAgICBpZiAoIXVzZXJzLmxlbmd0aCkge1xuICAgICAgICBuZXcgVXNlcih7dXNlcm5hbWU6IHVzZXJuYW1lLCBwYXNzd29yZDogcGFzc3dvcmQsIHBpY3R1cmU6IHBpY3R1cmV9KS5zYXZlKClcbiAgICAgICAgLnRoZW4odXNlciA9PiB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ05ldyB1c2VyOiAnLCB1c2VyKTtcbiAgICAgICAgICByZXEuc2Vzc2lvbi51c2VybmFtZSA9IHVzZXJuYW1lO1xuICAgICAgICAgIHJlcS5zZXNzaW9uLnBhc3N3b3JkID0gcGFzc3dvcmQ7XG4gICAgICAgICAgcmVxLnNlc3Npb24ucGljdHVyZSA9IHBpY3R1cmU7XG4gICAgICAgICAgcmVzLnJlZGlyZWN0KCcvJyk7XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZygnVGhhdCB1c2VyIGFscmVhZHkgZXhpc3RzJyk7XG4gICAgICAgIHJlcy5yZWRpcmVjdCgnL2xvZ2luJyk7XG4gICAgICB9XG4gICAgfSlcbiAgfSxcblxuICBjaGVja1Nlc3Npb246IChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIHZhciBwYXRoID0gcmVxLnBhdGg7XG4gICAgaWYgKHBhdGggPT09ICcvJyAmJiBwYXRoICE9PSAnL2xvZ2luJyAmJiBwYXRoICE9PSAnL3NpZ251cCcpIHtcbiAgICAgIGlmICghcmVxLnNlc3Npb24udXNlcm5hbWUgfHwgcmVxLnNlc3Npb24udXNlcm5hbWUgPT09IG51bGwpIHtcbiAgICAgICAgcmVzLnJlZGlyZWN0KCcvbG9naW4nKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5leHQoKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbmV4dCgpO1xuICAgIH1cbiAgfSxcblxuICBmZXRjaE1vdmllczogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgLy8gZmV0Y2hlcyBtb3ZpZXMgb24gbG9naW4sIGFuZCBwcm9maWxlIHBpY3R1cmVcbiAgICB2YXIgdXNlcm5hbWUgPSByZXEuc2Vzc2lvbi51c2VybmFtZTtcbiAgICB2YXIgcGljdHVyZSA9IHJlcS5zZXNzaW9uLnBpY3R1cmU7XG4gICAgY29uc29sZS5sb2codXNlcm5hbWUsIHBpY3R1cmUpO1xuICAgIFVzZXIuZmluZE9uZSh7dXNlcm5hbWU6IHVzZXJuYW1lfSkudGhlbih1c2VyID0+IHtcbiAgICAgIE1vdmllLmZpbmQoeydfaWQnOiB7XG4gICAgICAgICRpbjogdXNlci5tb3ZpZUxpc3RcbiAgICAgIH19KS50aGVuKG1vdmllcyA9PiB7XG4gICAgICAgIHJlcy5zZW5kKHttb3ZpZXM6IG1vdmllcywgcGljdHVyZTogcGljdHVyZX0pO1xuICAgICAgfSlcbiAgICB9KVxuICB9LFxuXG4gIG1hdGNoVXNlcjogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgdmFyIG1hdGNoID0gcmVxLmJvZHkubWF0Y2g7XG4gICAgVXNlci5maW5kT25lKHt1c2VybmFtZTogbWF0Y2h9KS50aGVuKHVzZXIgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ01hdGNoZWQgdXNlciBmb3VuZDogJywgdXNlcik7XG4gICAgICByZXMuc2VuZCh1c2VyKTtcbiAgICB9KVxuICB9LFxuXG4gIGFkZE1vdmllOiAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAvLyBzZW5kcyBtb3ZpZSBpbmZvXG4gICAgdmFyIG1vdmllID0gcmVxLmJvZHkubW92aWUuc3BsaXQoJyAnKS5qb2luKCcrJyk7XG4gICAgdmFyIHVybCA9IG9tZGIgKyAndG9tYXRvZXM9dHJ1ZSZ0PScgKyBtb3ZpZTtcbiAgICB2YXIgdXNlcm5hbWUgPSByZXEuc2Vzc2lvbi51c2VybmFtZTtcbiAgICBNb3ZpZS5maW5kKHt0aXRsZTogcmVxLmJvZHkubW92aWV9KS50aGVuKChtb3ZpZXMpID0+IHtcbiAgICAgIGlmICghbW92aWVzLmxlbmd0aCkge1xuICAgICAgICAvLyBhZGQgbW92aWUgdG8gZGIgaWYgdGhlIHF1ZXJ5IHJldHVybmVkIGVtcHR5XG4gICAgICAgIHJlcXVlc3QodXJsLCBmdW5jdGlvbihlcnIsIHJlc3BvbnNlLCBib2R5KSB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ2Vycm9yIGZyb20gb21kYiByZXF1ZXN0OiAnLCBlcnIpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB2YXIgZGF0YSA9IEpTT04ucGFyc2UocmVzcG9uc2UuYm9keSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnTW92aWUgZGF0YTogJywgZGF0YSk7XG4gICAgICAgICAgICB2YXIgaW5mbyA9IHtcbiAgICAgICAgICAgICAgdGl0bGU6IGRhdGEuVGl0bGUsXG4gICAgICAgICAgICAgIHllYXI6IGRhdGEuWWVhcixcbiAgICAgICAgICAgICAgaW1nOiBkYXRhLlBvc3RlcixcbiAgICAgICAgICAgICAgbGVuZ3RoOiBkYXRhLlJ1bnRpbWUsXG4gICAgICAgICAgICAgIHBsb3Q6IGRhdGEuUGxvdCxcbiAgICAgICAgICAgICAgcmF0aW5nOiBkYXRhLnRvbWF0b1VzZXJSYXRpbmdcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG5ldyBNb3ZpZShpbmZvKS5zYXZlKCkudGhlbihmdW5jdGlvbihtb3ZpZSkge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnU2F2aW5nIG1vdmllIHRvIGRiLi4nKTtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coJ01vdmllOiAnLCBtb3ZpZSk7XG4gICAgICAgICAgICAgIFVzZXIudXBkYXRlKHt1c2VybmFtZTogdXNlcm5hbWV9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICB7JHB1c2g6IHttb3ZpZUxpc3Q6IG1vdmllLl9pZH19LFxuICAgICAgICAgICAgICAgICAgICAgICAgICB7c2FmZTogdHJ1ZSwgdXBzZXJ0OiB0cnVlfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKGVyciwgbW9kZWwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZXJyIHVwZGF0aW5nIHVzZXIgbW92aWVMaXN0JywgZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICByZXMuc2VuZCh7bWF0Y2hlczogW10sXG4gICAgICAgICAgICAgICAgICAgICAgICBtb3ZpZTogbW92aWV9KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5sb2coJ01vdmllOiAnLCBtb3ZpZXNbMF0pO1xuICAgICAgICBVc2VyLnVwZGF0ZSh7dXNlcm5hbWU6IHVzZXJuYW1lfSxcbiAgICAgICAgICAgICAgICAgICAgeyRwdXNoOiB7bW92aWVMaXN0OiBtb3ZpZXNbMF0uX2lkfX0sXG4gICAgICAgICAgICAgICAgICAgIHtzYWZlOiB0cnVlLCB1cHNlcnQ6IHRydWV9LFxuICAgICAgICAgICAgICAgICAgICAoZXJyLCBtb2RlbCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlcnIgdXBkYXRpbmcgdXNlciBtb3ZpZUxpc3QnLCBlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBtb3ZpZXNbMF1cbiAgICAgIH1cbiAgICB9KS50aGVuKChtb3ZpZSkgPT4ge1xuICAgICAgLy8gZmluZHMgdXNlcnMgd2l0aCBtYXRjaGluZyBtb3ZpZXNcbiAgICAgIFVzZXIuZmluZE9uZSh7dXNlcm5hbWU6IHJlcS5zZXNzaW9uLnVzZXJuYW1lfSkudGhlbih1c2VyID0+IHtcbiAgICAgICAgVXNlci5maW5kKHttb3ZpZUxpc3Q6IHskaW46IFttb3ZpZS5faWRdfSxcbiAgICAgICAgICAgICAgICAgICB1c2VybmFtZTogeyRuZTogcmVxLnNlc3Npb24udXNlcm5hbWV9fSkudGhlbih1c2VycyA9PiB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ3RoZSBtYXRjaGluZyB1c2VyczogJywgdXNlcnMpO1xuICAgICAgICAgIHJlcy5zZW5kKHttYXRjaGVzOiB1c2VycyxcbiAgICAgICAgICAgICAgICAgICAgbW92aWU6IG1vdmllfSk7XG4gICAgICAgIH0pXG4gICAgICB9KVxuICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKCdlcnJvciBpbiBmaW5kaW5nIG1vdmllczogJywgZXJyKTtcbiAgICB9KVxuICB9LFxufSJdfQ==