'use strict';

// handles requests to every route

var db = require('../db/config.js');
var request = require('request');
var app = require('./server.js');
var _ = require('underscore');

var User = db.User;
var Movie = db.Movie;

var omdb = 'http://www.omdbapi.com/?';

module.exports = {
  login: function login(req, res, next) {
    var username = req.body.username;
    var password = req.body.password;
    User.findOne({ username: username, password: password }).then(function (user) {
      if (user) {
        req.session.username = req.body.username;
        req.session.password = req.body.password;
        console.log('Logging in..');
        res.redirect('/');
      } else {
        res.send('Invalid username/password. Please refresh');
      }
    });
  },

  logout: function logout(req, res, next) {
    req.session.username = null;
    req.session.password = null;
    console.log('Logging out..');
    res.redirect('/login');
  },

  signup: function signup(req, res, next) {
    console.log('Signing up..');
    var username = req.body.username;
    var password = req.body.password;
    User.find({ username: username }).then(function (users) {
      if (!users.length) {
        new User({ username: username, password: password }).save().then(function (user) {
          console.log('New user: ', user);
          req.session.username = req.body.username;
          req.session.password = req.body.password;
          res.redirect('/');
        });
      } else {
        console.log('That user already exists');
        res.redirect('/login');
      }
    });
  },

  checkSession: function checkSession(req, res, next) {
    var path = req.path;
    if (path === '/' && path !== '/login' && path !== '/signup') {
      if (!req.session.username || req.session.username === null) {
        res.redirect('/login');
      } else {
        next();
      }
    } else {
      next();
    }
  },

  addMovie: function addMovie(req, res, next) {
    var movie = req.body.movie.split(' ').join('+');
    var url = omdb + 'tomatoes=true&t=' + movie;
    var username = req.session.username;
    // var user = User.findOne({username: req.session.username})
    console.log(username);
    Movie.find({ title: req.body.movie }).then(function (movies) {
      // add movie to db if the query returned empty
      if (!movies.length) {
        request(url, function (err, response, body) {
          if (err) {
            console.log('error from omdb request: ', err);
          } else {
            var data = JSON.parse(response.body);
            console.log(data);
            var info = {
              title: data.Title,
              year: data.Year,
              img: data.Poster,
              length: data.Runtime,
              plot: data.Plot,
              rating: data.tomatoUserRating
            };
            new Movie(info).save().then(function (movie) {
              console.log('Saving movie to db');
              console.log('Movie: ', movie);
              User.update({ username: username }, { $push: { movieList: movie._id } }, { safe: true, upsert: true }, function (err, model) {
                if (err) {
                  console.log('err updating user movieList', err);
                }
              });
              res.send(movie);
            });
          }
        });
      } else {
        console.log('Movie: ', movies[0]);
        User.update({ username: username }, { $push: { movieList: movies[0]._id } }, { safe: true, upsert: true }, function (err, model) {
          if (err) {
            console.log('err updating user movieList', err);
          }
        });
        res.send(movies[0]);
      }
    }).catch(function (err) {
      console.log('error in finding movies: ', err);
    });
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvaGFuZGxlcnMuanMiXSwibmFtZXMiOlsiZGIiLCJyZXF1aXJlIiwicmVxdWVzdCIsImFwcCIsIl8iLCJVc2VyIiwiTW92aWUiLCJvbWRiIiwibW9kdWxlIiwiZXhwb3J0cyIsImxvZ2luIiwicmVxIiwicmVzIiwibmV4dCIsInVzZXJuYW1lIiwiYm9keSIsInBhc3N3b3JkIiwiZmluZE9uZSIsInRoZW4iLCJ1c2VyIiwic2Vzc2lvbiIsImNvbnNvbGUiLCJsb2ciLCJyZWRpcmVjdCIsInNlbmQiLCJsb2dvdXQiLCJzaWdudXAiLCJmaW5kIiwidXNlcnMiLCJsZW5ndGgiLCJzYXZlIiwiY2hlY2tTZXNzaW9uIiwicGF0aCIsImFkZE1vdmllIiwibW92aWUiLCJzcGxpdCIsImpvaW4iLCJ1cmwiLCJ0aXRsZSIsIm1vdmllcyIsImVyciIsInJlc3BvbnNlIiwiZGF0YSIsIkpTT04iLCJwYXJzZSIsImluZm8iLCJUaXRsZSIsInllYXIiLCJZZWFyIiwiaW1nIiwiUG9zdGVyIiwiUnVudGltZSIsInBsb3QiLCJQbG90IiwicmF0aW5nIiwidG9tYXRvVXNlclJhdGluZyIsInVwZGF0ZSIsIiRwdXNoIiwibW92aWVMaXN0IiwiX2lkIiwic2FmZSIsInVwc2VydCIsIm1vZGVsIiwiY2F0Y2giXSwibWFwcGluZ3MiOiI7O0FBQUE7O0FBRUEsSUFBSUEsS0FBS0MsUUFBUSxpQkFBUixDQUFUO0FBQ0EsSUFBSUMsVUFBVUQsUUFBUSxTQUFSLENBQWQ7QUFDQSxJQUFJRSxNQUFNRixRQUFRLGFBQVIsQ0FBVjtBQUNBLElBQUlHLElBQUlILFFBQVEsWUFBUixDQUFSOztBQUVBLElBQUlJLE9BQU9MLEdBQUdLLElBQWQ7QUFDQSxJQUFJQyxRQUFRTixHQUFHTSxLQUFmOztBQUVBLElBQUlDLE9BQU8sMEJBQVg7O0FBRUFDLE9BQU9DLE9BQVAsR0FBaUI7QUFDZkMsU0FBTyxlQUFDQyxHQUFELEVBQU1DLEdBQU4sRUFBV0MsSUFBWCxFQUFvQjtB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QUFRLElBQXJCLEVBRlosRUFHWSxVQUFDckIsR0FBRCxFQUFNc0IsS0FBTixFQUFnQjtBQUNkLG9CQUFJdEIsR0FBSixFQUFTO0FBQ1BuQiwwQkFBUUMsR0FBUixDQUFZLDZCQUFaLEVBQTJDa0IsR0FBM0M7QUFDRDtBQUNGLGVBUGI7QUFRQTVCLGtCQUFJWSxJQUFKLENBQVNVLEtBQVQ7QUFDRCxhQVpEO0FBYUQ7QUFDRixTQTVCRDtBQTZCRCxPQTlCRCxNQThCTztBQUNMYixnQkFBUUMsR0FBUixDQUFZLFNBQVosRUFBdUJpQixPQUFPLENBQVAsQ0FBdkI7QUFDQWxDLGFBQUttRCxNQUFMLENBQVksRUFBQzFDLFVBQVVBLFFBQVgsRUFBWixFQUNZLEVBQUMyQyxPQUFPLEVBQUNDLFdBQVduQixPQUFPLENBQVAsRUFBVW9CLEdBQXRCLEVBQVIsRUFEWixFQUVZLEVBQUNDLE1BQU0sSUFBUCxFQUFhQyxRQUFRLElBQXJCLEVBRlosRUFHWSxVQUFDckIsR0FBRCxFQUFNc0IsS0FBTixFQUFnQjtBQUNkLGNBQUl0QixHQUFKLEVBQVM7QUFDUG5CLG9CQUFRQyxHQUFSLENBQVksNkJBQVosRUFBMkNrQixHQUEzQztBQUNEO0FBQ0YsU0FQYjtBQVFBNUIsWUFBSVksSUFBSixDQUFTZSxPQUFPLENBQVAsQ0FBVDtBQUNEO0FBQ0YsS0E1Q0QsRUE0Q0d3QixLQTVDSCxDQTRDUyxVQUFDdkIsR0FBRCxFQUFTO0FBQ2hCbkIsY0FBUUMsR0FBUixDQUFZLDJCQUFaLEVBQXlDa0IsR0FBekM7QUFDRCxLQTlDRDtBQStDRDtBQTdHYyxDQUFqQiIsImZpbGUiOiJoYW5kbGVycy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIGhhbmRsZXMgcmVxdWVzdHMgdG8gZXZlcnkgcm91dGVcblxudmFyIGRiID0gcmVxdWlyZSgnLi4vZGIvY29uZmlnLmpzJyk7XG52YXIgcmVxdWVzdCA9IHJlcXVpcmUoJ3JlcXVlc3QnKTtcbnZhciBhcHAgPSByZXF1aXJlKCcuL3NlcnZlci5qcycpO1xudmFyIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7XG5cbnZhciBVc2VyID0gZGIuVXNlcjtcbnZhciBNb3ZpZSA9IGRiLk1vdmllO1xuXG52YXIgb21kYiA9ICdodHRwOi8vd3d3Lm9tZGJhcGkuY29tLz8nXG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBsb2dpbjogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgdmFyIHVzZXJuYW1lID0gcmVxLmJvZHkudXNlcm5hbWU7XG4gICAgdmFyIHBhc3N3b3JkID0gcmVxLmJvZHkucGFzc3dvcmQ7XG4gICAgVXNlci5maW5kT25lKHt1c2VybmFtZTogdXNlcm5hbWUsIHBhc3N3b3JkOiBwYXNzd29yZH0pLnRoZW4odXNlciA9PiB7XG4gICAgICBpZiAodXNlcikge1xuICAgICAgICByZXEuc2Vzc2lvbi51c2VybmFtZSA9IHJlcS5ib2R5LnVzZXJuYW1lO1xuICAgICAgICByZXEuc2Vzc2lvbi5wYXNzd29yZCA9IHJlcS5ib2R5LnBhc3N3b3JkO1xuICAgICAgICBjb25zb2xlLmxvZygnTG9nZ2luZyBpbi4uJyk7XG4gICAgICAgIHJlcy5yZWRpcmVjdCgnLycpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzLnNlbmQoJ0ludmFsaWQgdXNlcm5hbWUvcGFzc3dvcmQuIFBsZWFzZSByZWZyZXNoJyk7XG4gICAgICB9XG4gICAgfSlcbiAgfSxcblxuICBsb2dvdXQ6IChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIHJlcS5zZXNzaW9uLnVzZXJuYW1lID0gbnVsbDtcbiAgICByZXEuc2Vzc2lvbi5wYXNzd29yZCA9IG51bGw7XG4gICAgY29uc29sZS5sb2coJ0xvZ2dpbmcgb3V0Li4nKTtcbiAgICByZXMucmVkaXJlY3QoJy9sb2dpbicpO1xuICB9LFxuXG4gIHNpZ251cDogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgY29uc29sZS5sb2coJ1NpZ25pbmcgdXAuLicpO1xuICAgIHZhciB1c2VybmFtZSA9IHJlcS5ib2R5LnVzZXJuYW1lO1xuICAgIHZhciBwYXNzd29yZCA9IHJlcS5ib2R5LnBhc3N3b3JkO1xuICAgIFVzZXIuZmluZCh7dXNlcm5hbWU6IHVzZXJuYW1lfSkudGhlbih1c2VycyA9PiB7XG4gICAgICBpZiAoIXVzZXJzLmxlbmd0aCkge1xuICAgICAgICBuZXcgVXNlcih7dXNlcm5hbWU6IHVzZXJuYW1lLCBwYXNzd29yZDogcGFzc3dvcmR9KS5zYXZlKClcbiAgICAgICAgLnRoZW4odXNlciA9PiB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ05ldyB1c2VyOiAnLCB1c2VyKTtcbiAgICAgICAgICByZXEuc2Vzc2lvbi51c2VybmFtZSA9IHJlcS5ib2R5LnVzZXJuYW1lO1xuICAgICAgICAgIHJlcS5zZXNzaW9uLnBhc3N3b3JkID0gcmVxLmJvZHkucGFzc3dvcmQ7XG4gICAgICAgICAgcmVzLnJlZGlyZWN0KCcvJyk7XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZygnVGhhdCB1c2VyIGFscmVhZHkgZXhpc3RzJyk7XG4gICAgICAgIHJlcy5yZWRpcmVjdCgnL2xvZ2luJyk7XG4gICAgICB9XG4gICAgfSlcbiAgfSxcblxuICBjaGVja1Nlc3Npb246IChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIHZhciBwYXRoID0gcmVxLnBhdGg7XG4gICAgaWYgKHBhdGggPT09ICcvJyAmJiBwYXRoICE9PSAnL2xvZ2luJyAmJiBwYXRoICE9PSAnL3NpZ251cCcpIHtcbiAgICAgIGlmICghcmVxLnNlc3Npb24udXNlcm5hbWUgfHwgcmVxLnNlc3Npb24udXNlcm5hbWUgPT09IG51bGwpIHtcbiAgICAgICAgcmVzLnJlZGlyZWN0KCcvbG9naW4nKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5leHQoKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbmV4dCgpO1xuICAgIH1cbiAgfSxcblxuICBhZGRNb3ZpZTogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgdmFyIG1vdmllID0gcmVxLmJvZHkubW92aWUuc3BsaXQoJyAnKS5qb2luKCcrJyk7XG4gICAgdmFyIHVybCA9IG9tZGIgKyAndG9tYXRvZXM9dHJ1ZSZ0PScgKyBtb3ZpZTtcbiAgICB2YXIgdXNlcm5hbWUgPSByZXEuc2Vzc2lvbi51c2VybmFtZTtcbiAgICAvLyB2YXIgdXNlciA9IFVzZXIuZmluZE9uZSh7dXNlcm5hbWU6IHJlcS5zZXNzaW9uLnVzZXJuYW1lfSlcbiAgICBjb25zb2xlLmxvZyh1c2VybmFtZSk7XG4gICAgTW92aWUuZmluZCh7dGl0bGU6IHJlcS5ib2R5Lm1vdmllfSkudGhlbigobW92aWVzKSA9PiB7XG4gICAgICAvLyBhZGQgbW92aWUgdG8gZGIgaWYgdGhlIHF1ZXJ5IHJldHVybmVkIGVtcHR5XG4gICAgICBpZiAoIW1vdmllcy5sZW5ndGgpIHtcbiAgICAgICAgcmVxdWVzdCh1cmwsIGZ1bmN0aW9uKGVyciwgcmVzcG9uc2UsIGJvZHkpIHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnZXJyb3IgZnJvbSBvbWRiIHJlcXVlc3Q6ICcsIGVycik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciBkYXRhID0gSlNPTi5wYXJzZShyZXNwb25zZS5ib2R5KTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGRhdGEpO1xuICAgICAgICAgICAgdmFyIGluZm8gPSB7XG4gICAgICAgICAgICAgIHRpdGxlOiBkYXRhLlRpdGxlLFxuICAgICAgICAgICAgICB5ZWFyOiBkYXRhLlllYXIsXG4gICAgICAgICAgICAgIGltZzogZGF0YS5Qb3N0ZXIsXG4gICAgICAgICAgICAgIGxlbmd0aDogZGF0YS5SdW50aW1lLFxuICAgICAgICAgICAgICBwbG90OiBkYXRhLlBsb3QsXG4gICAgICAgICAgICAgIHJhdGluZzogZGF0YS50b21hdG9Vc2VyUmF0aW5nXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBuZXcgTW92aWUoaW5mbykuc2F2ZSgpLnRoZW4oZnVuY3Rpb24obW92aWUpIHtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1NhdmluZyBtb3ZpZSB0byBkYicpO1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnTW92aWU6ICcsIG1vdmllKTtcbiAgICAgICAgICAgICAgVXNlci51cGRhdGUoe3VzZXJuYW1lOiB1c2VybmFtZX0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHskcHVzaDoge21vdmllTGlzdDogbW92aWUuX2lkfX0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHtzYWZlOiB0cnVlLCB1cHNlcnQ6IHRydWV9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAoZXJyLCBtb2RlbCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlcnIgdXBkYXRpbmcgdXNlciBtb3ZpZUxpc3QnLCBlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIHJlcy5zZW5kKG1vdmllKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5sb2coJ01vdmllOiAnLCBtb3ZpZXNbMF0pO1xuICAgICAgICBVc2VyLnVwZGF0ZSh7dXNlcm5hbWU6IHVzZXJuYW1lfSxcbiAgICAgICAgICAgICAgICAgICAgeyRwdXNoOiB7bW92aWVMaXN0OiBtb3ZpZXNbMF0uX2lkfX0sXG4gICAgICAgICAgICAgICAgICAgIHtzYWZlOiB0cnVlLCB1cHNlcnQ6IHRydWV9LFxuICAgICAgICAgICAgICAgICAgICAoZXJyLCBtb2RlbCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlcnIgdXBkYXRpbmcgdXNlciBtb3ZpZUxpc3QnLCBlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIHJlcy5zZW5kKG1vdmllc1swXSk7XG4gICAgICB9XG4gICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ2Vycm9yIGluIGZpbmRpbmcgbW92aWVzOiAnLCBlcnIpO1xuICAgIH0pXG4gIH1cbn0iXX0=