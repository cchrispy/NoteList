'use strict';

// handles requests to every route
// interacts with the database

var db = require('../db/config.js');
var request = require('request');
var app = require('./server.js');
var _ = require('underscore');

var User = db.User;
var Movie = db.Movie;

var omdb = 'http://www.omdbapi.com/?';

module.exports = {
  login: function login(req, res, next) {
    var username = req.body.username;
    var password = req.body.password;
    User.findOne({ username: username, password: password }).then(function (user) {
      if (user) {
        req.session.username = req.body.username;
        req.session.password = req.body.password;
        console.log('Logging in..');
        res.redirect('/');
      } else {
        res.send('Invalid username/password. Please refresh');
      }
    });
  },

  logout: function logout(req, res, next) {
    req.session.username = null;
    req.session.password = null;
    console.log('Logging out..');
    res.redirect('/login');
  },

  signup: function signup(req, res, next) {
    console.log('Signing up..');
    var username = req.body.username;
    var password = req.body.password;
    User.find({ username: username }).then(function (users) {
      if (!users.length) {
        new User({ username: username, password: password }).save().then(function (user) {
          console.log('New user: ', user);
          req.session.username = req.body.username;
          req.session.password = req.body.password;
          res.redirect('/');
        });
      } else {
        console.log('That user already exists');
        res.redirect('/login');
      }
    });
  },

  checkSession: function checkSession(req, res, next) {
    var path = req.path;
    if (path === '/' && path !== '/login' && path !== '/signup') {
      if (!req.session.username || req.session.username === null) {
        res.redirect('/login');
      } else {
        next();
      }
    } else {
      next();
    }
  },

  fetchMovies: function fetchMovies(req, res, next) {
    // fetches movies on login
    var username = req.session.username;
    User.findOne({ username: username }).then(function (user) {
      Movie.find({ '_id': {
          $in: user.movieList
        } }).then(function (movies) {
        res.send(movies);
      });
    });
  },

  matchUser: function matchUser(req, res, next) {
    var match = req.body.match;
    User.findOne({ username: match }).then(function (user) {
      console.log('Matched user found: ', user);
      res.send(user);
    });
  },

  addMovie: function addMovie(req, res, next) {
    // sends movie info
    var movie = req.body.movie.split(' ').join('+');
    var url = omdb + 'tomatoes=true&t=' + movie;
    var username = req.session.username;
    Movie.find({ title: req.body.movie }).then(function (movies) {
      if (!movies.length) {
        // add movie to db if the query returned empty
        request(url, function (err, response, body) {
          if (err) {
            console.log('error from omdb request: ', err);
          } else {
            var data = JSON.parse(response.body);
            console.log('Movie data: ', data);
            var info = {
              title: data.Title,
              year: data.Year,
              img: data.Poster,
              length: data.Runtime,
              plot: data.Plot,
              rating: data.tomatoUserRating
            };
            new Movie(info).save().then(function (movie) {
              console.log('Saving movie to db..');
              console.log('Movie: ', movie);
              User.update({ username: username }, { $push: { movieList: movie._id } }, { safe: true, upsert: true }, function (err, model) {
                if (err) {
                  console.log('err updating user movieList', err);
                }
              });
              res.send({ matches: [],
                movie: movie });
            });
          }
        });
      } else {
        console.log('Movie: ', movies[0]);
        User.update({ username: username }, { $push: { movieList: movies[0]._id } }, { safe: true, upsert: true }, function (err, model) {
          if (err) {
            console.log('err updating user movieList', err);
          }
        });
        return movies[0];
      }
    }).then(function (movie) {
      // finds users with matching movies
      User.findOne({ username: req.session.username }).then(function (user) {
        User.find({ movieList: { $in: [movie._id] },
          username: { $ne: req.session.username } }).then(function (users) {
          console.log('the matching users: ', users);
          res.send({ matches: users,
            movie: movie });
        });
      });
    }).catch(function (err) {
      console.log('error in finding movies: ', err);
    });
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvaGFuZGxlcnMuanMiXSwibmFtZXMiOlsiZGIiLCJyZXF1aXJlIiwicmVxdWVzdCIsImFwcCIsIl8iLCJVc2VyIiwiTW92aWUiLCJvbWRiIiwibW9kdWxlIiwiZXhwb3J0cyIsImxvZ2luIiwicmVxIiwicmVzIiwibmV4dCIsInVzZXJuYW1lIiwiYm9keSIsInBhc3N3b3JkIiwiZmluZE9uZSIsInRoZW4iLCJ1c2VyIiwic2Vzc2lvbiIsImNvbnNvbGUiLCJsb2ciLCJyZWRpcmVjdCIsInNlbmQiLCJsb2dvdXQiLCJzaWdudXAiLCJmaW5kIiwidXNlcnMiLCJsZW5ndGgiLCJzYXZlIiwiY2hlY2tTZXNzaW9uIiwicGF0aCIsImZldGNoTW92aWVzIiwiJGluIiwibW92aWVMaXN0IiwibW92aWVzIiwibWF0Y2hVc2VyIiwibWF0Y2giLCJhZGRNb3ZpZSIsIm1vdmllIiwic3BsaXQiLCJqb2luIiwidXJsIiwidGl0bGUiLCJlcnIiLCJyZXNwb25zZSIsImRhdGEiLCJKU09OIiwicGFyc2UiLCJpbmZvIiwiVGl0bGUiLCJ5ZWFyIiwiWWVhciIsImltZyIsIlBvc3RlciIsIlJ1bnRpbWUiLCJwbG90IiwiUGxvdCIsInJhdGluZyIsInRvbWF0b1VzZXJSYXRpbmciLCJ1cGRhdGUiLCIkcHVzaCIsIl9pZCIsInNhZmUiLCJ1cHNlcnQiLCJtb2RlbCIsIm1hdGNoZXMiLCIkbmUiLCJjYXRjaCJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBOztBQUVBLElBQUlBLEtBQUtDLFFBQVEsaUJBQVIsQ0FBVDtBQUNBLElBQUlDLFVBQVVELFFBQVEsU0FBUixDQUFkO0FBQ0EsSUFBSUUsTUFBTUYsUUFBUSxhQUFSLENBQVY7QUFDQSxJQUFJRyxJQUFJSCxRQUFRLFlBQVIsQ0FBUjs7QUFFQSxJQUFJSSxPQUFPTCxHQUFHSyxJQUFkO0FBQ0EsSUFBSUMsUUFBUU4sR0FBR00sS0FBZjs7QUFFQSxJQUFJQyxPQUFPLDBCQUFYOztBQUVBQyxPQUFPQyxP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b3VyY2VzQ29udGVudCI6WyIvLyBoYW5kbGVzIHJlcXVlc3RzIHRvIGV2ZXJ5IHJvdXRlXG4vLyBpbnRlcmFjdHMgd2l0aCB0aGUgZGF0YWJhc2VcblxudmFyIGRiID0gcmVxdWlyZSgnLi4vZGIvY29uZmlnLmpzJyk7XG52YXIgcmVxdWVzdCA9IHJlcXVpcmUoJ3JlcXVlc3QnKTtcbnZhciBhcHAgPSByZXF1aXJlKCcuL3NlcnZlci5qcycpO1xudmFyIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7XG5cbnZhciBVc2VyID0gZGIuVXNlcjtcbnZhciBNb3ZpZSA9IGRiLk1vdmllO1xuXG52YXIgb21kYiA9ICdodHRwOi8vd3d3Lm9tZGJhcGkuY29tLz8nXG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBsb2dpbjogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgdmFyIHVzZXJuYW1lID0gcmVxLmJvZHkudXNlcm5hbWU7XG4gICAgdmFyIHBhc3N3b3JkID0gcmVxLmJvZHkucGFzc3dvcmQ7XG4gICAgVXNlci5maW5kT25lKHt1c2VybmFtZTogdXNlcm5hbWUsIHBhc3N3b3JkOiBwYXNzd29yZH0pLnRoZW4odXNlciA9PiB7XG4gICAgICBpZiAodXNlcikge1xuICAgICAgICByZXEuc2Vzc2lvbi51c2VybmFtZSA9IHJlcS5ib2R5LnVzZXJuYW1lO1xuICAgICAgICByZXEuc2Vzc2lvbi5wYXNzd29yZCA9IHJlcS5ib2R5LnBhc3N3b3JkO1xuICAgICAgICBjb25zb2xlLmxvZygnTG9nZ2luZyBpbi4uJyk7XG4gICAgICAgIHJlcy5yZWRpcmVjdCgnLycpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzLnNlbmQoJ0ludmFsaWQgdXNlcm5hbWUvcGFzc3dvcmQuIFBsZWFzZSByZWZyZXNoJyk7XG4gICAgICB9XG4gICAgfSlcbiAgfSxcblxuICBsb2dvdXQ6IChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIHJlcS5zZXNzaW9uLnVzZXJuYW1lID0gbnVsbDtcbiAgICByZXEuc2Vzc2lvbi5wYXNzd29yZCA9IG51bGw7XG4gICAgY29uc29sZS5sb2coJ0xvZ2dpbmcgb3V0Li4nKTtcbiAgICByZXMucmVkaXJlY3QoJy9sb2dpbicpO1xuICB9LFxuXG4gIHNpZ251cDogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgY29uc29sZS5sb2coJ1NpZ25pbmcgdXAuLicpO1xuICAgIHZhciB1c2VybmFtZSA9IHJlcS5ib2R5LnVzZXJuYW1lO1xuICAgIHZhciBwYXNzd29yZCA9IHJlcS5ib2R5LnBhc3N3b3JkO1xuICAgIFVzZXIuZmluZCh7dXNlcm5hbWU6IHVzZXJuYW1lfSkudGhlbih1c2VycyA9PiB7XG4gICAgICBpZiAoIXVzZXJzLmxlbmd0aCkge1xuICAgICAgICBuZXcgVXNlcih7dXNlcm5hbWU6IHVzZXJuYW1lLCBwYXNzd29yZDogcGFzc3dvcmR9KS5zYXZlKClcbiAgICAgICAgLnRoZW4odXNlciA9PiB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ05ldyB1c2VyOiAnLCB1c2VyKTtcbiAgICAgICAgICByZXEuc2Vzc2lvbi51c2VybmFtZSA9IHJlcS5ib2R5LnVzZXJuYW1lO1xuICAgICAgICAgIHJlcS5zZXNzaW9uLnBhc3N3b3JkID0gcmVxLmJvZHkucGFzc3dvcmQ7XG4gICAgICAgICAgcmVzLnJlZGlyZWN0KCcvJyk7XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZygnVGhhdCB1c2VyIGFscmVhZHkgZXhpc3RzJyk7XG4gICAgICAgIHJlcy5yZWRpcmVjdCgnL2xvZ2luJyk7XG4gICAgICB9XG4gICAgfSlcbiAgfSxcblxuICBjaGVja1Nlc3Npb246IChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIHZhciBwYXRoID0gcmVxLnBhdGg7XG4gICAgaWYgKHBhdGggPT09ICcvJyAmJiBwYXRoICE9PSAnL2xvZ2luJyAmJiBwYXRoICE9PSAnL3NpZ251cCcpIHtcbiAgICAgIGlmICghcmVxLnNlc3Npb24udXNlcm5hbWUgfHwgcmVxLnNlc3Npb24udXNlcm5hbWUgPT09IG51bGwpIHtcbiAgICAgICAgcmVzLnJlZGlyZWN0KCcvbG9naW4nKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5leHQoKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbmV4dCgpO1xuICAgIH1cbiAgfSxcblxuICBmZXRjaE1vdmllczogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgLy8gZmV0Y2hlcyBtb3ZpZXMgb24gbG9naW5cbiAgICB2YXIgdXNlcm5hbWUgPSByZXEuc2Vzc2lvbi51c2VybmFtZTtcbiAgICBVc2VyLmZpbmRPbmUoe3VzZXJuYW1lOiB1c2VybmFtZX0pLnRoZW4odXNlciA9PiB7XG4gICAgICBNb3ZpZS5maW5kKHsnX2lkJzoge1xuICAgICAgICAkaW46IHVzZXIubW92aWVMaXN0XG4gICAgICB9fSkudGhlbihtb3ZpZXMgPT4ge1xuICAgICAgICByZXMuc2VuZChtb3ZpZXMpO1xuICAgICAgfSlcbiAgICB9KVxuICB9LFxuXG4gIG1hdGNoVXNlcjogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgdmFyIG1hdGNoID0gcmVxLmJvZHkubWF0Y2g7XG4gICAgVXNlci5maW5kT25lKHt1c2VybmFtZTogbWF0Y2h9KS50aGVuKHVzZXIgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ01hdGNoZWQgdXNlciBmb3VuZDogJywgdXNlcik7XG4gICAgICByZXMuc2VuZCh1c2VyKTtcbiAgICB9KVxuICB9LFxuXG4gIGFkZE1vdmllOiAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAvLyBzZW5kcyBtb3ZpZSBpbmZvXG4gICAgdmFyIG1vdmllID0gcmVxLmJvZHkubW92aWUuc3BsaXQoJyAnKS5qb2luKCcrJyk7XG4gICAgdmFyIHVybCA9IG9tZGIgKyAndG9tYXRvZXM9dHJ1ZSZ0PScgKyBtb3ZpZTtcbiAgICB2YXIgdXNlcm5hbWUgPSByZXEuc2Vzc2lvbi51c2VybmFtZTtcbiAgICBNb3ZpZS5maW5kKHt0aXRsZTogcmVxLmJvZHkubW92aWV9KS50aGVuKChtb3ZpZXMpID0+IHtcbiAgICAgIGlmICghbW92aWVzLmxlbmd0aCkge1xuICAgICAgICAvLyBhZGQgbW92aWUgdG8gZGIgaWYgdGhlIHF1ZXJ5IHJldHVybmVkIGVtcHR5XG4gICAgICAgIHJlcXVlc3QodXJsLCBmdW5jdGlvbihlcnIsIHJlc3BvbnNlLCBib2R5KSB7XG4gICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ2Vycm9yIGZyb20gb21kYiByZXF1ZXN0OiAnLCBlcnIpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB2YXIgZGF0YSA9IEpTT04ucGFyc2UocmVzcG9uc2UuYm9keSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnTW92aWUgZGF0YTogJywgZGF0YSk7XG4gICAgICAgICAgICB2YXIgaW5mbyA9IHtcbiAgICAgICAgICAgICAgdGl0bGU6IGRhdGEuVGl0bGUsXG4gICAgICAgICAgICAgIHllYXI6IGRhdGEuWWVhcixcbiAgICAgICAgICAgICAgaW1nOiBkYXRhLlBvc3RlcixcbiAgICAgICAgICAgICAgbGVuZ3RoOiBkYXRhLlJ1bnRpbWUsXG4gICAgICAgICAgICAgIHBsb3Q6IGRhdGEuUGxvdCxcbiAgICAgICAgICAgICAgcmF0aW5nOiBkYXRhLnRvbWF0b1VzZXJSYXRpbmdcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG5ldyBNb3ZpZShpbmZvKS5zYXZlKCkudGhlbihmdW5jdGlvbihtb3ZpZSkge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnU2F2aW5nIG1vdmllIHRvIGRiLi4nKTtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coJ01vdmllOiAnLCBtb3ZpZSk7XG4gICAgICAgICAgICAgIFVzZXIudXBkYXRlKHt1c2VybmFtZTogdXNlcm5hbWV9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICB7JHB1c2g6IHttb3ZpZUxpc3Q6IG1vdmllLl9pZH19LFxuICAgICAgICAgICAgICAgICAgICAgICAgICB7c2FmZTogdHJ1ZSwgdXBzZXJ0OiB0cnVlfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKGVyciwgbW9kZWwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZXJyIHVwZGF0aW5nIHVzZXIgbW92aWVMaXN0JywgZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICByZXMuc2VuZCh7bWF0Y2hlczogW10sXG4gICAgICAgICAgICAgICAgICAgICAgICBtb3ZpZTogbW92aWV9KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5sb2coJ01vdmllOiAnLCBtb3ZpZXNbMF0pO1xuICAgICAgICBVc2VyLnVwZGF0ZSh7dXNlcm5hbWU6IHVzZXJuYW1lfSxcbiAgICAgICAgICAgICAgICAgICAgeyRwdXNoOiB7bW92aWVMaXN0OiBtb3ZpZXNbMF0uX2lkfX0sXG4gICAgICAgICAgICAgICAgICAgIHtzYWZlOiB0cnVlLCB1cHNlcnQ6IHRydWV9LFxuICAgICAgICAgICAgICAgICAgICAoZXJyLCBtb2RlbCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlcnIgdXBkYXRpbmcgdXNlciBtb3ZpZUxpc3QnLCBlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBtb3ZpZXNbMF1cbiAgICAgIH1cbiAgICB9KS50aGVuKChtb3ZpZSkgPT4ge1xuICAgICAgLy8gZmluZHMgdXNlcnMgd2l0aCBtYXRjaGluZyBtb3ZpZXNcbiAgICAgIFVzZXIuZmluZE9uZSh7dXNlcm5hbWU6IHJlcS5zZXNzaW9uLnVzZXJuYW1lfSkudGhlbih1c2VyID0+IHtcbiAgICAgICAgVXNlci5maW5kKHttb3ZpZUxpc3Q6IHskaW46IFttb3ZpZS5faWRdfSxcbiAgICAgICAgICAgICAgICAgICB1c2VybmFtZTogeyRuZTogcmVxLnNlc3Npb24udXNlcm5hbWV9fSkudGhlbih1c2VycyA9PiB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ3RoZSBtYXRjaGluZyB1c2VyczogJywgdXNlcnMpO1xuICAgICAgICAgIHJlcy5zZW5kKHttYXRjaGVzOiB1c2VycyxcbiAgICAgICAgICAgICAgICAgICAgbW92aWU6IG1vdmllfSk7XG4gICAgICAgIH0pXG4gICAgICB9KVxuICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKCdlcnJvciBpbiBmaW5kaW5nIG1vdmllczogJywgZXJyKTtcbiAgICB9KVxuICB9LFxufSJdfQ==