'use strict';

var db = require('../db/config.js');
var request = require('request');
var app = require('./server.js');
var _ = require('underscore');

var User = db.User;
var Movie = db.Movie;

var omdb = 'http://www.omdbapi.com/?';

module.exports = {
  login: function login(req, res, next) {
    var username = req.body.username;
    var password = req.body.password;
    User.findOne({ username: username, password: password }).then(function (user) {
      console.log(user);
      if (user) {
        req.session.username = req.body.username;
        req.session.password = req.body.password;
        res.redirect('/');
      } else {
        res.send('Invalid username/password. Please refresh');
      }
    });
  },
  logout: function logout(req, res, next) {
    req.session.username = null;
    req.session.password = null;
    console.log('LOGOUT SESSION: ', req.session);
    res.redirect('/login');
  },
  signup: function signup(req, res, next) {
    console.log('signing up..');
    var username = req.body.username;
    var password = req.body.password;
    User.find({ username: username }).then(function (users) {
      if (!users.length) {
        new User({ username: username, password: password }).save().then(function (user) {
          console.log('new user: ', user);
          req.session.username = req.body.username;
          req.session.password = req.body.password;
          res.redirect('/');
        });
      } else {
        console.log('that user already exists');
        res.redirect('/login');
      }
    });
  },
  checkSession: function checkSession(req, res, next) {
    var path = req.path;
    if (path === '/' && path !== '/login' && path !== '/signup') {
      if (!req.session.username || req.session.username === null) {
        res.redirect('/login');
      } else {
        next();
      }
    } else {
      next();
    }
  },
  addMovie: function addMovie(req, res, next) {
    var movie = req.body.movie.split(' ').join('+');
    var url = omdb + 'tomatoes=true&t=' + movie;
    Movie.find({ title: req.body.movie }).then(function (movies) {
      // add movie to db if the query returned empty
      if (!movies.length) {
        request(url, function (err, response, body) {
          if (err) {
            console.log('error from omdb request: ', err);
          } else {
            var data = JSON.parse(response.body);
            console.log(data);
            var info = {
              title: data.Title,
              year: data.Year,
              img: data.Poster,
              length: data.Runtime,
              plot: data.Plot,
              rating: data.tomatoUserRating
            };
            new Movie(info).save().then(function (movie) {
              console.log('saving movie to db');
              res.send(movie);
            });
          }
        });
      } else {
        res.send(movies[0]);
      }
    }).catch(function (err) {
      console.log('error in finding movies: ', err);
    });
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvaGFuZGxlcnMuanMiXSwibmFtZXMiOlsiZGIiLCJyZXF1aXJlIiwicmVxdWVzdCIsImFwcCIsIl8iLCJVc2VyIiwiTW92aWUiLCJvbWRiIiwibW9kdWxlIiwiZXhwb3J0cyIsImxvZ2luIiwicmVxIiwicmVzIiwibmV4dCIsInVzZXJuYW1lIiwiYm9keSIsInBhc3N3b3JkIiwiZmluZE9uZSIsInRoZW4iLCJjb25zb2xlIiwibG9nIiwidXNlciIsInNlc3Npb24iLCJyZWRpcmVjdCIsInNlbmQiLCJsb2dvdXQiLCJzaWdudXAiLCJmaW5kIiwidXNlcnMiLCJsZW5ndGgiLCJzYXZlIiwiY2hlY2tTZXNzaW9uIiwicGF0aCIsImFkZE1vdmllIiwibW92aWUiLCJzcGxpdCIsImpvaW4iLCJ1cmwiLCJ0aXRsZSIsIm1vdmllcyIsImVyciIsInJlc3BvbnNlIiwiZGF0YSIsIkpTT04iLCJwYXJzZSIsImluZm8iLCJUaXRsZSIsInllYXIiLCJZZWFyIiwiaW1nIiwiUG9zdGVyIiwiUnVudGltZSIsInBsb3QiLCJQbG90IiwicmF0aW5nIiwidG9tYXRvVXNlclJhdGluZyIsImNhdGNoIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQUlBLEtBQUtDLFFBQVEsaUJBQVIsQ0FBVDtBQUNBLElBQUlDLFVBQVVELFFBQVEsU0FBUixDQUFkO0FBQ0EsSUFBSUUsTUFBTUYsUUFBUSxhQUFSLENBQVY7QUFDQSxJQUFJRyxJQUFJSCxRQUFRLFlBQVIsQ0FBUjs7QUFFQSxJQUFJSSxPQUFPTCxHQUFHSyxJQUFkO0FBQ0EsSUFBSUMsUUFBUU4sR0FBR00sS0FBZjs7QUFFQSxJQUFJQyxPQUFPLDBCQUFYOztBQUVBQyxPQUFPQyxPQUFQLEdBQWlCO0FBQ2ZDLFNBQU8sZUFBQ0MsR0FBRCxFQUFNQyxHQUFOLEVBQVdDLElBQVgsRUFBb0I7QUFDekIsUUFBSUMsV0FBV0gsSUFBSUksSUFBSixDQUFTRCxRQUF4QjtBQUNBLFFBQUlFLFdBQVdMLElBQUlJLElB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cmUoJy4uL2RiL2NvbmZpZy5qcycpO1xudmFyIHJlcXVlc3QgPSByZXF1aXJlKCdyZXF1ZXN0Jyk7XG52YXIgYXBwID0gcmVxdWlyZSgnLi9zZXJ2ZXIuanMnKTtcbnZhciBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpO1xuXG52YXIgVXNlciA9IGRiLlVzZXI7XG52YXIgTW92aWUgPSBkYi5Nb3ZpZTtcblxudmFyIG9tZGIgPSAnaHR0cDovL3d3dy5vbWRiYXBpLmNvbS8/J1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgbG9naW46IChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIHZhciB1c2VybmFtZSA9IHJlcS5ib2R5LnVzZXJuYW1lO1xuICAgIHZhciBwYXNzd29yZCA9IHJlcS5ib2R5LnBhc3N3b3JkO1xuICAgIFVzZXIuZmluZE9uZSh7dXNlcm5hbWU6IHVzZXJuYW1lLCBwYXNzd29yZDogcGFzc3dvcmR9KS50aGVuKHVzZXIgPT4ge1xuICAgICAgY29uc29sZS5sb2codXNlcik7XG4gICAgICBpZiAodXNlcikge1xuICAgICAgICByZXEuc2Vzc2lvbi51c2VybmFtZSA9IHJlcS5ib2R5LnVzZXJuYW1lO1xuICAgICAgICByZXEuc2Vzc2lvbi5wYXNzd29yZCA9IHJlcS5ib2R5LnBhc3N3b3JkO1xuICAgICAgICByZXMucmVkaXJlY3QoJy8nKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcy5zZW5kKCdJbnZhbGlkIHVzZXJuYW1lL3Bhc3N3b3JkLiBQbGVhc2UgcmVmcmVzaCcpO1xuICAgICAgfVxuICAgIH0pXG4gIH0sXG4gIGxvZ291dDogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgcmVxLnNlc3Npb24udXNlcm5hbWUgPSBudWxsO1xuICAgIHJlcS5zZXNzaW9uLnBhc3N3b3JkID0gbnVsbDtcbiAgICBjb25zb2xlLmxvZygnTE9HT1VUIFNFU1NJT046ICcsIHJlcS5zZXNzaW9uKTtcbiAgICByZXMucmVkaXJlY3QoJy9sb2dpbicpO1xuICB9LFxuICBzaWdudXA6IChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIGNvbnNvbGUubG9nKCdzaWduaW5nIHVwLi4nKTtcbiAgICB2YXIgdXNlcm5hbWUgPSByZXEuYm9keS51c2VybmFtZTtcbiAgICB2YXIgcGFzc3dvcmQgPSByZXEuYm9keS5wYXNzd29yZDtcbiAgICBVc2VyLmZpbmQoe3VzZXJuYW1lOiB1c2VybmFtZX0pLnRoZW4odXNlcnMgPT4ge1xuICAgICAgaWYgKCF1c2Vycy5sZW5ndGgpIHtcbiAgICAgICAgbmV3IFVzZXIoe3VzZXJuYW1lOiB1c2VybmFtZSwgcGFzc3dvcmQ6IHBhc3N3b3JkfSkuc2F2ZSgpXG4gICAgICAgIC50aGVuKHVzZXIgPT4ge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCduZXcgdXNlcjogJywgdXNlcik7XG4gICAgICAgICAgcmVxLnNlc3Npb24udXNlcm5hbWUgPSByZXEuYm9keS51c2VybmFtZTtcbiAgICAgICAgICByZXEuc2Vzc2lvbi5wYXNzd29yZCA9IHJlcS5ib2R5LnBhc3N3b3JkO1xuICAgICAgICAgIHJlcy5yZWRpcmVjdCgnLycpO1xuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5sb2coJ3RoYXQgdXNlciBhbHJlYWR5IGV4aXN0cycpO1xuICAgICAgICByZXMucmVkaXJlY3QoJy9sb2dpbicpO1xuICAgICAgfVxuICAgIH0pXG4gIH0sXG4gIGNoZWNrU2Vzc2lvbjogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgdmFyIHBhdGggPSByZXEucGF0aDtcbiAgICBpZiAocGF0aCA9PT0gJy8nICYmIHBhdGggIT09ICcvbG9naW4nICYmIHBhdGggIT09ICcvc2lnbnVwJykge1xuICAgICAgaWYgKCFyZXEuc2Vzc2lvbi51c2VybmFtZSB8fCByZXEuc2Vzc2lvbi51c2VybmFtZSA9PT0gbnVsbCkge1xuICAgICAgICByZXMucmVkaXJlY3QoJy9sb2dpbicpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbmV4dCgpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBuZXh0KCk7XG4gICAgfVxuICB9LFxuICBhZGRNb3ZpZTogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgdmFyIG1vdmllID0gcmVxLmJvZHkubW92aWUuc3BsaXQoJyAnKS5qb2luKCcrJyk7XG4gICAgdmFyIHVybCA9IG9tZGIgKyAndG9tYXRvZXM9dHJ1ZSZ0PScgKyBtb3ZpZTtcbiAgICBNb3ZpZS5maW5kKHt0aXRsZTogcmVxLmJvZHkubW92aWV9KS50aGVuKChtb3ZpZXMpID0+IHtcbiAgICAgIC8vIGFkZCBtb3ZpZSB0byBkYiBpZiB0aGUgcXVlcnkgcmV0dXJuZWQgZW1wdHlcbiAgICAgIGlmICghbW92aWVzLmxlbmd0aCkge1xuICAgICAgICByZXF1ZXN0KHVybCwgZnVuY3Rpb24oZXJyLCByZXNwb25zZSwgYm9keSkge1xuICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlcnJvciBmcm9tIG9tZGIgcmVxdWVzdDogJywgZXJyKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFyIGRhdGEgPSBKU09OLnBhcnNlKHJlc3BvbnNlLmJvZHkpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coZGF0YSk7XG4gICAgICAgICAgICB2YXIgaW5mbyA9IHtcbiAgICAgICAgICAgICAgdGl0bGU6IGRhdGEuVGl0bGUsXG4gICAgICAgICAgICAgIHllYXI6IGRhdGEuWWVhcixcbiAgICAgICAgICAgICAgaW1nOiBkYXRhLlBvc3RlcixcbiAgICAgICAgICAgICAgbGVuZ3RoOiBkYXRhLlJ1bnRpbWUsXG4gICAgICAgICAgICAgIHBsb3Q6IGRhdGEuUGxvdCxcbiAgICAgICAgICAgICAgcmF0aW5nOiBkYXRhLnRvbWF0b1VzZXJSYXRpbmdcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG5ldyBNb3ZpZShpbmZvKS5zYXZlKCkudGhlbihmdW5jdGlvbihtb3ZpZSkge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnc2F2aW5nIG1vdmllIHRvIGRiJyk7XG4gICAgICAgICAgICAgIHJlcy5zZW5kKG1vdmllKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzLnNlbmQobW92aWVzWzBdKTtcbiAgICAgIH1cbiAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICBjb25zb2xlLmxvZygnZXJyb3IgaW4gZmluZGluZyBtb3ZpZXM6ICcsIGVycik7XG4gICAgfSlcbiAgfVxufSJdfQ==