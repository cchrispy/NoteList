'use strict';

var db = require('../db/config.js');
var request = require('request');
var app = require('./server.js');

var User = db.User;
var Movie = db.Movie;

var omdb = 'http://www.omdbapi.com/?';

module.exports = {
  login: function login(req, res, next) {
    req.session.username = req.body.username;
    req.session.password = req.body.password;
    console.log(req.session);
    res.redirect('/');
  },
  logout: function logout(req, res, next) {
    req.session.username = null;
    req.session.password = null;
    console.log(req.session);
    res.redirect('/login');
  },
  addMovie: function addMovie(req, res, next) {
    var movie = req.body.movie.split(' ').join('+');
    var url = omdb + 'tomatoes=true&t=' + movie;
    Movie.find({ title: req.body.movie }).then(function (movies) {
      // add movie to db if the query returned empty
      if (!movies.length) {
        request(url, function (err, response, body) {
          if (err) {
            console.log('error from omdb request: ', err);
          } else {
            var data = JSON.parse(response.body);
            console.log(data);
            var info = {
              title: data.Title,
              year: data.Year,
              img: data.Poster,
              length: data.Runtime,
              plot: data.Plot,
              rating: data.tomatoUserRating
            };
            new Movie(info).save().then(function (movie) {
              console.log('saving movie to db');
              res.send(movie);
            });
          }
        });
      } else {
        res.send(movies[0]);
      }
    }).catch(function (err) {
      console.log('error in finding movies: ', err);
    });
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2ZXIvaGFuZGxlcnMuanMiXSwibmFtZXMiOlsiZGIiLCJyZXF1aXJlIiwicmVxdWVzdCIsImFwcCIsIlVzZXIiLCJNb3ZpZSIsIm9tZGIiLCJtb2R1bGUiLCJleHBvcnRzIiwibG9naW4iLCJyZXEiLCJyZXMiLCJuZXh0Iiwic2Vzc2lvbiIsInVzZXJuYW1lIiwiYm9keSIsInBhc3N3b3JkIiwiY29uc29sZSIsImxvZyIsInJlZGlyZWN0IiwibG9nb3V0IiwiYWRkTW92aWUiLCJtb3ZpZSIsInNwbGl0Iiwiam9pbiIsInVybCIsImZpbmQiLCJ0aXRsZSIsInRoZW4iLCJtb3ZpZXMiLCJsZW5ndGgiLCJlcnIiLCJyZXNwb25zZSIsImRhdGEiLCJKU09OIiwicGFyc2UiLCJpbmZvIiwiVGl0bGUiLCJ5ZWFyIiwiWWVhciIsImltZyIsIlBvc3RlciIsIlJ1bnRpbWUiLCJwbG90IiwiUGxvdCIsInJhdGluZyIsInRvbWF0b1VzZXJSYXRpbmciLCJzYXZlIiwic2VuZCIsImNhdGNoIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQUlBLEtBQUtDLFFBQVEsaUJBQVIsQ0FBVDtBQUNBLElBQUlDLFVBQVVELFFBQVEsU0FBUixDQUFkO0FBQ0EsSUFBSUUsTUFBTUYsUUFBUSxhQUFSLENBQVY7O0FBRUEsSUFBSUcsT0FBT0osR0FBR0ksSUFBZDtBQUNBLElBQUlDLFFBQVFMLEdBQUdLLEtBQWY7O0FBRUEsSUFBSUMsT0FBTywwQkFBWDs7QUFFQUMsT0FBT0MsT0FBUCxHQUFpQjtBQUNmQyxTQUFPLGVBQUNDLEdBQUQsRUFBTUMsR0FBTixFQUFXQyxJQUFYLEVBQW9CO0FBQ3pCRixRQUFJRyxPQUFKLENBQVlDLFFBQVosR0FBdUJKLElBQUlLLElBQUosQ0FBU0QsUUFBaEM7QUFDQUosUUFBSUcsT0FBSixDQUFZRyxRQUFaLEdBQXVCTixJQUFJSyxJQUFKLENBQVNDLFFBQWhDO0FBQ0FDLFlBQVFDLEdBQVIsQ0FBWVIsSUFBSUcsT0FBaEI7QUFDQUYsUUFBSVEsUUFBSixDQUFhLEdBQWI7QUFDRCxHQU5jO0FBT2ZDLFVBQVEsZ0JBQUNWLEdBQUQsRUFBTUMsR0FBTixFQUFXQyxJQUFYLEVBQW9CO0FBQzFCRixRQUFJRyxPQUFKLENBQVlDLFFBQVosR0FBdUIsSUFBdkI7QUFDQUosUUFBSUcsT0FBSixDQUFZRyxRQUFaLEdBQXVCLElBQXZCO0FBQ0FDLFlBQVFDLEdBQVIsQ0FBWVIsSUFBSUcsT0FBaEI7QUFDQUYsUUFBSVEsUUFBSixDQUFhLFFBQWI7QUFDRCxHQVpjO0FBYWZFLFlBQVUsa0JBQUNYLEdBQUQsRUFBTUMsR0FBTixFQUFXQyxJQUFYLEVBQW9CO0FBQzVCLFFBQUlVLFFBQVFaLElBQUlLLElBQUosQ0FBU08sS0FBVCxDQUFlQyxLQUFmLENBQXFCLEdBQXJCLEVBQTBCQyxJQUExQixDQUErQixHQUEvQixDQUFaO0FBQ0EsUUFBSUMsTUFBTW5CLE9BQU8sa0JBQVAsR0FBNEJnQixLQUF0QztBQUNBakIsVUFBTXFCLElBQU4sQ0FBVyxFQUFDQyxPQUFPakIsSUFBSUssSUFBSixDQUFTTyxLQUFqQixFQUFYLEVBQW9DTSxJQUFwQyxDQUF5QyxVQUFDQyxNQUFELEVBQVk7QUFDbkQ7QUFDQSxVQUFJLENBQUNBLE9BQU9DLE1BQVosRUFBb0I7QUFDbEI1QixnQkFBUXVCLEdBQVIsRUFBYSxVQUFTTSxHQUFULEVBQWNDLFFBQWQsRUFBd0JqQixJQUF4QixFQUE4QjtBQUN6QyxjQUFJZ0IsR0FBSixFQUFTO0FBQ1BkLG9CQUFRQyxHQUFSLENBQVksMkJBQVosRUFBeUNhLEdBQXpDO0FBQ0QsV0FGRCxNQUVPO0FBQ0wsZ0JBQUlFLE9BQU9DLEtBQUtDLEtBQUwsQ0FBV0gsU0FBU2pCLElBQXBCLENBQVg7QUFDQUUsb0JBQVFDLEdBQVIsQ0FBWWUsSUFBWjtBQUNBLGdCQUFJRyxPQUFPO0FBQ1RULHFCQUFPTSxLQUFLSSxLQURIO0FBRVRDLG9CQUFNTCxLQUFLTSxJQUZGO0FBR1RDLG1CQUFLUCxLQUFLUSxNQUhEO0FBSVRYLHNCQUFRRyxLQUFLUyxPQUpKO0FBS1RDLG9CQUFNVixLQUFLVyxJQUxGO0FBTVRDLHNCQUFRWixLQUFLYTtBQU5KLGFBQVg7QUFRQSxnQkFBSXpDLEtBQUosQ0FBVStCLElBQVYsRUFBZ0JXLElBQWhCLEdBQXVCbkIsSUFBdkIsQ0FBNEIsVUFBU04sS0FBVCxFQUFnQjtBQUMxQ0wsc0JBQVFDLEdBQVIsQ0FBWSxvQkFBWjtBQUNBUCxrQkFBSXFDLElBQUosQ0FBUzFCLEtBQVQ7QUFDRCxhQUhEO0FBSUQ7QUFDRixTQW5CRDtBQW9CRCxPQXJCRCxNQXFCTztBQUNMWCxZQUFJcUMsSUFBSixDQUFTbkIsT0FBTyxDQUFQLENBQVQ7QUFDRDtBQUNGLEtBMUJELEVBMEJHb0IsS0ExQkgsQ0EwQlMsVUFBQ2xCLEdBQUQsRUFBUztBQUNoQmQsY0FBUUMsR0FBUixDQUFZLDJCQUFaLEVBQXlDYSxHQUF6QztBQUNELEtBNUJEO0FBNkJEO0FBN0NjLENBQWpCIiwiZmlsZSI6ImhhbmRsZXJzLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGRiID0gcmVxdWlyZSgnLi4vZGIvY29uZmlnLmpzJyk7XG52YXIgcmVxdWVzdCA9IHJlcXVpcmUoJ3JlcXVlc3QnKTtcbnZhciBhcHAgPSByZXF1aXJlKCcuL3NlcnZlci5qcycpO1xuXG52YXIgVXNlciA9IGRiLlVzZXI7XG52YXIgTW92aWUgPSBkYi5Nb3ZpZTtcblxudmFyIG9tZGIgPSAnaHR0cDovL3d3dy5vbWRiYXBpLmNvbS8/J1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgbG9naW46IChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIHJlcS5zZXNzaW9uLnVzZXJuYW1lID0gcmVxLmJvZHkudXNlcm5hbWU7XG4gICAgcmVxLnNlc3Npb24ucGFzc3dvcmQgPSByZXEuYm9keS5wYXNzd29yZDtcbiAgICBjb25zb2xlLmxvZyhyZXEuc2Vzc2lvbik7XG4gICAgcmVzLnJlZGlyZWN0KCcvJyk7XG4gIH0sXG4gIGxvZ291dDogKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgcmVxLnNlc3Npb24udXNlcm5hbWUgPSBudWxsO1xuICAgIHJlcS5zZXNzaW9uLnBhc3N3b3JkID0gbnVsbDtcbiAgICBjb25zb2xlLmxvZyhyZXEuc2Vzc2lvbik7XG4gICAgcmVzLnJlZGlyZWN0KCcvbG9naW4nKTtcbiAgfSxcbiAgYWRkTW92aWU6IChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIHZhciBtb3ZpZSA9IHJlcS5ib2R5Lm1vdmllLnNwbGl0KCcgJykuam9pbignKycpO1xuICAgIHZhciB1cmwgPSBvbWRiICsgJ3RvbWF0b2VzPXRydWUmdD0nICsgbW92aWU7XG4gICAgTW92aWUuZmluZCh7dGl0bGU6IHJlcS5ib2R5Lm1vdmllfSkudGhlbigobW92aWVzKSA9PiB7XG4gICAgICAvLyBhZGQgbW92aWUgdG8gZGIgaWYgdGhlIHF1ZXJ5IHJldHVybmVkIGVtcHR5XG4gICAgICBpZiAoIW1vdmllcy5sZW5ndGgpIHtcbiAgICAgICAgcmVxdWVzdCh1cmwsIGZ1bmN0aW9uKGVyciwgcmVzcG9uc2UsIGJvZHkpIHtcbiAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnZXJyb3IgZnJvbSBvbWRiIHJlcXVlc3Q6ICcsIGVycik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciBkYXRhID0gSlNPTi5wYXJzZShyZXNwb25zZS5ib2R5KTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGRhdGEpO1xuICAgICAgICAgICAgdmFyIGluZm8gPSB7XG4gICAgICAgICAgICAgIHRpdGxlOiBkYXRhLlRpdGxlLFxuICAgICAgICAgICAgICB5ZWFyOiBkYXRhLlllYXIsXG4gICAgICAgICAgICAgIGltZzogZGF0YS5Qb3N0ZXIsXG4gICAgICAgICAgICAgIGxlbmd0aDogZGF0YS5SdW50aW1lLFxuICAgICAgICAgICAgICBwbG90OiBkYXRhLlBsb3QsXG4gICAgICAgICAgICAgIHJhdGluZzogZGF0YS50b21hdG9Vc2VyUmF0aW5nXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBuZXcgTW92aWUoaW5mbykuc2F2ZSgpLnRoZW4oZnVuY3Rpb24obW92aWUpIHtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3NhdmluZyBtb3ZpZSB0byBkYicpO1xuICAgICAgICAgICAgICByZXMuc2VuZChtb3ZpZSk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcy5zZW5kKG1vdmllc1swXSk7XG4gICAgICB9XG4gICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ2Vycm9yIGluIGZpbmRpbmcgbW92aWVzOiAnLCBlcnIpO1xuICAgIH0pXG4gIH1cbn0iXX0=